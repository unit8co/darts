
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>darts.explainability.tft_explainer &#8212; darts  documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/docs-favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../../index.html">
  <img src="../../../_static/darts-logo-trim.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../README.html">
  Home
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../quickstart/00-quickstart.html">
  Quickstart
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../userguide.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../generated_api/darts.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../examples.html">
  Examples
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/unit8co/darts" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/unit8co" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for darts.explainability.tft_explainer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TFT Explainer for Temporal Fusion Transformer (TFTModel)</span>
<span class="sd">------------------------------------</span>

<span class="sd">The `TFTExplainer` uses a trained :class:`TFTModel &lt;darts.models.forecasting.tft_model.TFTModel&gt;` and extracts the</span>
<span class="sd">explainability information from the model.</span>

<span class="sd">- :func:`plot_variable_selection() &lt;TFTExplainer.plot_variable_selection&gt;` plots the variable selection weights for</span>
<span class="sd">  each of the input features.</span>
<span class="sd">  - encoder importance: historic part of target, past covariates and historic part of future covariates</span>
<span class="sd">  - decoder importance: future part of future covariates</span>
<span class="sd">  - static covariates importance: the numeric and catageorical static covariates importance</span>

<span class="sd">- :func:`plot_attention() &lt;TFTExplainer.plot_attention&gt;` plots the transformer attention that the `TFTModel` applies</span>
<span class="sd">  on the given past and future input. The attention is aggregated over all attention heads.</span>

<span class="sd">The attention and feature importance values can be extracted using the :class:`TFTExplainabilityResult</span>
<span class="sd">&lt;darts.explainability.explainability_result.TFTExplainabilityResult&gt;` returned by</span>
<span class="sd">:func:`explain() &lt;TFTExplainer.explain&gt;`. An example of this is shown in the method description.</span>

<span class="sd">We also show how to use the `TFTExplainer` in the example notebook of the `TFTModel` `here</span>
<span class="sd">&lt;https://unit8co.github.io/darts/examples/13-TFT-examples.html#Explainability&gt;`_.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">matplotlib.axes</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>

<span class="kn">from</span> <span class="nn">darts</span> <span class="kn">import</span> <span class="n">TimeSeries</span>
<span class="kn">from</span> <span class="nn">darts.explainability</span> <span class="kn">import</span> <span class="n">TFTExplainabilityResult</span>
<span class="kn">from</span> <span class="nn">darts.explainability.explainability</span> <span class="kn">import</span> <span class="n">_ForecastingModelExplainer</span>
<span class="kn">from</span> <span class="nn">darts.logging</span> <span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">raise_log</span>
<span class="kn">from</span> <span class="nn">darts.models</span> <span class="kn">import</span> <span class="n">TFTModel</span>
<span class="kn">from</span> <span class="nn">darts.utils.timeseries_generation</span> <span class="kn">import</span> <span class="n">generate_index</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="TFTExplainer"><a class="viewcode-back" href="../../../generated_api/darts.explainability.tft_explainer.html#darts.explainability.tft_explainer.TFTExplainer">[docs]</a><span class="k">class</span> <span class="nc">TFTExplainer</span><span class="p">(</span><span class="n">_ForecastingModelExplainer</span><span class="p">):</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">TFTModel</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">TFTModel</span><span class="p">,</span>
        <span class="n">background_series</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">background_past_covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">background_future_covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explainer class for the `TFTModel`.</span>

<span class="sd">        **Definitions**</span>

<span class="sd">        - A background series is a `TimeSeries` that is used as a default for generating the explainability result</span>
<span class="sd">          (if no `foreground` is passed to :func:`explain() &lt;TFTExplainer.explain&gt;`).</span>
<span class="sd">        - A foreground series is a `TimeSeries` that can be passed to :func:`explain() &lt;TFTExplainer.explain&gt;` to use</span>
<span class="sd">          instead of the background for generating the explainability result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model</span>
<span class="sd">            The fitted `TFTModel` to be explained.</span>
<span class="sd">        background_series</span>
<span class="sd">            Optionally, a series or list of series to use as a default target series for the explanations.</span>
<span class="sd">            Optional if `model` was trained on a single target series. By default, it is the `series` used at fitting</span>
<span class="sd">            time.</span>
<span class="sd">            Mandatory if `model` was trained on multiple (sequence of) target series.</span>
<span class="sd">        background_past_covariates</span>
<span class="sd">            Optionally, a past covariates series or list of series to use as a default past covariates series</span>
<span class="sd">            for the explanations. The same requirements apply as for `background_series` .</span>
<span class="sd">        background_future_covariates</span>
<span class="sd">            Optionally, a future covariates series or list of series to use as a default future covariates series</span>
<span class="sd">            for the explanations. The same requirements apply as for `background_series`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from darts.datasets import AirPassengersDataset</span>
<span class="sd">        &gt;&gt;&gt; from darts.explainability.tft_explainer import TFTExplainer</span>
<span class="sd">        &gt;&gt;&gt; from darts.models import TFTModel</span>
<span class="sd">        &gt;&gt;&gt; series = AirPassengersDataset().load()</span>
<span class="sd">        &gt;&gt;&gt; model = TFTModel(</span>
<span class="sd">        &gt;&gt;&gt;     input_chunk_length=12,</span>
<span class="sd">        &gt;&gt;&gt;     output_chunk_length=6,</span>
<span class="sd">        &gt;&gt;&gt;     add_encoders={&quot;cyclic&quot;: {&quot;future&quot;: [&quot;hour&quot;]}}</span>
<span class="sd">        &gt;&gt;&gt; )</span>
<span class="sd">        &gt;&gt;&gt; model.fit(series)</span>
<span class="sd">        &gt;&gt;&gt; # create the explainer and generate explanations</span>
<span class="sd">        &gt;&gt;&gt; explainer = TFTExplainer(model)</span>
<span class="sd">        &gt;&gt;&gt; results = explainer.explain()</span>
<span class="sd">        &gt;&gt;&gt; # plot the results</span>
<span class="sd">        &gt;&gt;&gt; explainer.plot_attention(results, plot_type=&quot;all&quot;)</span>
<span class="sd">        &gt;&gt;&gt; explainer.plot_variable_selection(results)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">background_series</span><span class="o">=</span><span class="n">background_series</span><span class="p">,</span>
            <span class="n">background_past_covariates</span><span class="o">=</span><span class="n">background_past_covariates</span><span class="p">,</span>
            <span class="n">background_future_covariates</span><span class="o">=</span><span class="n">background_future_covariates</span><span class="p">,</span>
            <span class="n">requires_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">requires_covariates_encoding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">check_component_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">test_stationarity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># add the relative index that generated inside the model (not in the input data)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">add_relative_index</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">future_covariates_components</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">future_covariates_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;add_relative_index&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">future_covariates_components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;add_relative_index&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="TFTExplainer.explain"><a class="viewcode-back" href="../../../generated_api/darts.explainability.tft_explainer.html#darts.explainability.tft_explainer.TFTExplainer.explain">[docs]</a>    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">foreground_series</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">foreground_past_covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">foreground_future_covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">horizons</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">target_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TFTExplainabilityResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the :class:`TFTExplainabilityResult</span>
<span class="sd">        &lt;darts.explainability.explainability_result.TFTExplainabilityResult&gt;` result for all series in</span>
<span class="sd">        `foreground_series`. If `foreground_series` is `None`, will use the `background` input</span>
<span class="sd">        from `TFTExplainer` creation (either the `background` passed to creation, or the series stored in the</span>
<span class="sd">        `TFTModel` in case it was only trained on a single series).</span>
<span class="sd">        For each series, the results contain the attention heads, encoder variable importances, decoder variable</span>
<span class="sd">        importances, and static covariates importances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        foreground_series</span>
<span class="sd">            Optionally, one or a sequence of target `TimeSeries` to be explained. Can be multivariate.</span>
<span class="sd">            If not provided, the background `TimeSeries` will be explained instead.</span>
<span class="sd">        foreground_past_covariates</span>
<span class="sd">            Optionally, one or a sequence of past covariates `TimeSeries` if required by the forecasting model.</span>
<span class="sd">        foreground_future_covariates</span>
<span class="sd">            Optionally, one or a sequence of future covariates `TimeSeries` if required by the forecasting model.</span>
<span class="sd">        horizons</span>
<span class="sd">            This parameter is not used by the `TFTExplainer`.</span>
<span class="sd">        target_components</span>
<span class="sd">            This parameter is not used by the `TFTExplainer`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TFTExplainabilityResult</span>
<span class="sd">            The explainability result containing the attention heads, encoder variable importances, decoder variable</span>
<span class="sd">            importances, and static covariates importances.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; explainer = TFTExplainer(model)  # requires `background` if model was trained on multiple series</span>

<span class="sd">        Optionally, give a foreground input to generate the explanation on a new input.</span>
<span class="sd">        Otherwise, leave it empty to compute the explanation on the background from `TFTExplainer` creation</span>

<span class="sd">        &gt;&gt;&gt; explain_results = explainer.explain(</span>
<span class="sd">        &gt;&gt;&gt;     foreground_series=foreground_series,</span>
<span class="sd">        &gt;&gt;&gt;     foreground_past_covariates=foreground_past_covariates,</span>
<span class="sd">        &gt;&gt;&gt;     foreground_future_covariates=foreground_future_covariates,</span>
<span class="sd">        &gt;&gt;&gt; )</span>
<span class="sd">        &gt;&gt;&gt; attn = explain_results.get_attention()</span>
<span class="sd">        &gt;&gt;&gt; importances = explain_results.get_feature_importances()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target_components</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">horizons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;`horizons`, and `target_components` are not supported by `TFTExplainer` and will be ignored.&quot;</span>
            <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span>
            <span class="n">foreground_series</span><span class="p">,</span> <span class="n">foreground_past_covariates</span><span class="p">,</span> <span class="n">foreground_future_covariates</span>
        <span class="p">)</span>
        <span class="p">(</span>
            <span class="n">foreground_series</span><span class="p">,</span>
            <span class="n">foreground_past_covariates</span><span class="p">,</span>
            <span class="n">foreground_future_covariates</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_foreground</span><span class="p">(</span>
            <span class="n">foreground_series</span><span class="p">,</span>
            <span class="n">foreground_past_covariates</span><span class="p">,</span>
            <span class="n">foreground_future_covariates</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">horizons</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_horizons_and_targets</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="n">foreground_series</span><span class="p">,</span>
            <span class="n">past_covariates</span><span class="o">=</span><span class="n">foreground_past_covariates</span><span class="p">,</span>
            <span class="n">future_covariates</span><span class="o">=</span><span class="n">foreground_future_covariates</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># get the weights and the attention head from the trained model for the prediction</span>
        <span class="c1"># aggregate over attention heads</span>
        <span class="n">attention_heads</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_attn_out_weights</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># get the variable importances (pd.DataFrame with rows corresponding to the number of input series)</span>
        <span class="n">encoder_importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoder_importance</span>
        <span class="n">decoder_importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decoder_importance</span>
        <span class="n">static_covariates_importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_covariates_importance</span>

        <span class="n">horizon_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">horizons</span><span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">icl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_chunk_length</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">foreground_series</span><span class="p">,</span> <span class="n">preds</span><span class="p">)):</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">time_index</span><span class="p">[</span><span class="o">-</span><span class="n">icl</span><span class="p">:]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">pred_series</span><span class="o">.</span><span class="n">time_index</span><span class="p">)</span>
            <span class="n">attention</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_times_and_values</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">attention_heads</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">horizon_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;horizon </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">horizons</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;attention&quot;</span><span class="p">:</span> <span class="n">attention</span><span class="p">,</span>
                    <span class="s2">&quot;encoder_importance&quot;</span><span class="p">:</span> <span class="n">encoder_importance</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;decoder_importance&quot;</span><span class="p">:</span> <span class="n">decoder_importance</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;static_covariates_importance&quot;</span><span class="p">:</span> <span class="n">static_covariates_importance</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                        <span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">TFTExplainabilityResult</span><span class="p">(</span>
            <span class="n">explanations</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">results</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TFTExplainer.plot_variable_selection"><a class="viewcode-back" href="../../../generated_api/darts.explainability.tft_explainer.html#darts.explainability.tft_explainer.TFTExplainer.plot_variable_selection">[docs]</a>    <span class="k">def</span> <span class="nf">plot_variable_selection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">expl_result</span><span class="p">:</span> <span class="n">TFTExplainabilityResult</span><span class="p">,</span>
        <span class="n">fig_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_nr_series</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the variable selection / feature importances of the `TFTModel` based on the input.</span>
<span class="sd">        The figure includes three subplots:</span>

<span class="sd">        - encoder importances: contains the past target, past covariates, and historic future covariates importance</span>
<span class="sd">          on the encoder (input chunk)</span>
<span class="sd">        - decoder importances: contains the future covariates importance on the decoder (output chunk)</span>
<span class="sd">        - static covariates importances: contains the numeric and / or categorical static covariates importance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        expl_result</span>
<span class="sd">            A `TFTExplainabilityResult` object. Corresponds to the output of :func:`explain() &lt;TFTExplainer.explain&gt;`.</span>
<span class="sd">        fig_size</span>
<span class="sd">            The size of the figure to be plotted.</span>
<span class="sd">        max_nr_series</span>
<span class="sd">            The maximum number of plots to show in case `expl_result` was computed on multiple series.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">encoder_importance</span> <span class="o">=</span> <span class="n">expl_result</span><span class="o">.</span><span class="n">get_encoder_importance</span><span class="p">()</span>
        <span class="n">decoder_importance</span> <span class="o">=</span> <span class="n">expl_result</span><span class="o">.</span><span class="n">get_decoder_importance</span><span class="p">()</span>
        <span class="n">static_covariates_importance</span> <span class="o">=</span> <span class="n">expl_result</span><span class="o">.</span><span class="n">get_static_covariates_importance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">encoder_importance</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">encoder_importance</span> <span class="o">=</span> <span class="p">[</span><span class="n">encoder_importance</span><span class="p">]</span>
            <span class="n">decoder_importance</span> <span class="o">=</span> <span class="p">[</span><span class="n">decoder_importance</span><span class="p">]</span>
            <span class="n">static_covariates_importance</span> <span class="o">=</span> <span class="p">[</span><span class="n">static_covariates_importance</span><span class="p">]</span>

        <span class="n">uses_static_covariates</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">static_covariates_importance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">enc_imp</span><span class="p">,</span> <span class="n">dec_imp</span><span class="p">,</span> <span class="n">stc_imp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">encoder_importance</span><span class="p">,</span> <span class="n">decoder_importance</span><span class="p">,</span> <span class="n">static_covariates_importance</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># plot the encoder and decoder weights</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span> <span class="k">if</span> <span class="n">uses_static_covariates</span> <span class="k">else</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_cov_selection</span><span class="p">(</span>
                <span class="n">enc_imp</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Encoder variable importance&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_cov_selection</span><span class="p">(</span>
                <span class="n">dec_imp</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Decoder variable importance&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">uses_static_covariates</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_cov_selection</span><span class="p">(</span>
                    <span class="n">stc_imp</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Static variable importance&quot;</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">max_nr_series</span><span class="p">:</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="TFTExplainer.plot_attention"><a class="viewcode-back" href="../../../generated_api/darts.explainability.tft_explainer.html#darts.explainability.tft_explainer.TFTExplainer.plot_attention">[docs]</a>    <span class="k">def</span> <span class="nf">plot_attention</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">expl_result</span><span class="p">:</span> <span class="n">TFTExplainabilityResult</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;heatmap&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">show_index_as</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relative&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_nr_series</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">show_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the attention heads of the `TFTModel`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        expl_result</span>
<span class="sd">            A `TFTExplainabilityResult` object. Corresponds to the output of :func:`explain() &lt;TFTExplainer.explain&gt;`.</span>
<span class="sd">        plot_type</span>
<span class="sd">            The type of attention head plot. One of (&quot;all&quot;, &quot;time&quot;, &quot;heatmap&quot;).</span>
<span class="sd">            If &quot;all&quot;, will plot the attention per horizon (given the horizons in the `TFTExplainabilityResult`).</span>
<span class="sd">            The maximum horizon corresponds to the `output_chunk_length` of the trained `TFTModel`.</span>
<span class="sd">            If &quot;time&quot;, will plot the mean attention over all horizons.</span>
<span class="sd">            If &quot;heatmap&quot;, will plot the attention per horizon on a heat map. The horizons are shown on the y-axis,</span>
<span class="sd">            and times / relative indices on the x-axis.</span>
<span class="sd">        show_index_as</span>
<span class="sd">            The type of index to be shown. One of (&quot;relative&quot;, &quot;time&quot;).</span>
<span class="sd">            If &quot;relative&quot;, will plot the x-axis from `(-input_chunk_length, output_chunk_length - 1)`. `0` corresponds</span>
<span class="sd">            to the first prediction point.</span>
<span class="sd">            If &quot;time&quot;, will plot the x-axis with the actual time index (or range index) of the corresponding</span>
<span class="sd">            `TFTExplainabilityResult`.</span>
<span class="sd">        ax</span>
<span class="sd">            Optionally, an axis to plot on. Only effective on a single `expl_result`.</span>
<span class="sd">        max_nr_series</span>
<span class="sd">            The maximum number of plots to show in case `expl_result` was computed on multiple series.</span>
<span class="sd">        show_plot</span>
<span class="sd">            Whether to show the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">single_series</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">attentions</span> <span class="o">=</span> <span class="n">expl_result</span><span class="o">.</span><span class="n">get_explanation</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s2">&quot;attention&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attentions</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">):</span>
            <span class="n">attentions</span> <span class="o">=</span> <span class="p">[</span><span class="n">attentions</span><span class="p">]</span>
            <span class="n">single_series</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">attention</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attentions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">single_series</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">show_index_as</span> <span class="o">==</span> <span class="s2">&quot;relative&quot;</span><span class="p">:</span>
                <span class="n">x_ticks</span> <span class="o">=</span> <span class="n">generate_index</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_chunk_length</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">attention</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_times_and_values</span><span class="p">(</span>
                    <span class="n">times</span><span class="o">=</span><span class="n">generate_index</span><span class="p">(</span>
                        <span class="n">start</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_chunk_length</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">),</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">attention</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                    <span class="n">columns</span><span class="o">=</span><span class="n">attention</span><span class="o">.</span><span class="n">components</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;Index relative to first prediction point&quot;</span>
            <span class="k">elif</span> <span class="n">show_index_as</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="n">x_ticks</span> <span class="o">=</span> <span class="n">attention</span><span class="o">.</span><span class="n">time_index</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;Time index&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_label</span><span class="p">,</span> <span class="n">x_ticks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="n">raise_log</span><span class="p">(</span>
                    <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`show_index_as` must either be &#39;relative&#39;, or &#39;time&#39;.&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">prediction_start_color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">ax_title</span> <span class="o">=</span> <span class="s2">&quot;Attention per Horizon&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Attention&quot;</span>
                <span class="n">attention</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_nr_components</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="n">ax_title</span> <span class="o">=</span> <span class="s2">&quot;Mean Attention&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Attention&quot;</span>
                <span class="n">attention</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean Attention Head&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;heatmap&quot;</span><span class="p">:</span>
                <span class="n">ax_title</span> <span class="o">=</span> <span class="s2">&quot;Attention Heat Map&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Horizon&quot;</span>

                <span class="c1"># generate a heat map</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_ticks</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">attention</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;hot&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()])</span>
                <span class="n">prediction_start_color</span> <span class="o">=</span> <span class="s2">&quot;lightblue&quot;</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">raise_log</span><span class="p">(</span>
                    <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`plot_type` must be either &#39;all&#39;, &#39;time&#39; or &#39;heatmap&#39;&quot;</span><span class="p">),</span>
                    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># draw the prediction start point</span>
            <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_ticks</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">],</span>
                <span class="n">ymin</span><span class="o">=</span><span class="n">y_min</span><span class="p">,</span>
                <span class="n">ymax</span><span class="o">=</span><span class="n">y_max</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction start&quot;</span><span class="p">,</span>
                <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">prediction_start_color</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="n">title_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">single_series</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;: series index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ax_title</span> <span class="o">+</span> <span class="n">title_suffix</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">max_nr_series</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">ax</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_encoder_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the encoder variable importance of the TFT model.</span>

<span class="sd">        The encoder_weights are calculated for the past inputs of the model.</span>
<span class="sd">        The encoder_importance contains the weights of the encoder variable selection network.</span>
<span class="sd">        The encoder variable selection network is used to select the most important static and time dependent</span>
<span class="sd">        covariates. It provides insights which variable are most significant for the prediction problem.</span>
<span class="sd">        See section 4.2 of the paper for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The encoder variable importance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_importance</span><span class="p">(</span>
            <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_encoder_sparse_weights</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder_variables</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_decoder_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the decoder variable importance of the TFT model.</span>

<span class="sd">        The decoder_weights are calculated for the known future inputs of the model.</span>
<span class="sd">        The decoder_importance contains the weights of the decoder variable selection network.</span>
<span class="sd">        The decoder variable selection network is used to select the most important static and time dependent</span>
<span class="sd">        covariates. It provides insights which variable are most significant for the prediction problem.</span>
<span class="sd">        See section 4.2 of the paper for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The importance of the decoder variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_importance</span><span class="p">(</span>
            <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_decoder_sparse_weights</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder_variables</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_static_covariates_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the static covariates importance of the TFT model.</span>

<span class="sd">        The static covariate importances are calculated for the static inputs of the model (numeric and / or</span>
<span class="sd">        categorical). The static variable selection network is used to select the most important static covariates.</span>
<span class="sd">        It provides insights which variable are most significant for the prediction problem.</span>
<span class="sd">        See section 4.2, and 4.3 of the paper for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The static covariates importance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_importance</span><span class="p">(</span>
            <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_static_covariate_var</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">static_variables</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_importance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">weight</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">n_decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the encoder or decoder variable of the TFT model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weights</span>
<span class="sd">            The weights of the encoder or decoder of the trained TFT model.</span>
<span class="sd">        names</span>
<span class="sd">            The encoder or decoder names saved in the TFT model class.</span>
<span class="sd">        n_decimals</span>
<span class="sd">            The number of decimals to round the importance to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The importance of the variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># static covariates aggregation needs expansion in first dimension</span>
        <span class="k">if</span> <span class="n">weight</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># transform the encoder/decoder weights to percentages, rounded to n_decimals</span>
        <span class="n">weights_percentage</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">n_decimals</span><span class="p">)</span>
            <span class="o">*</span> <span class="mi">100</span>
        <span class="p">)</span>
        <span class="c1"># create a dataframe with the variable names and the weights</span>
        <span class="n">name_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_mapping</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">weights_percentage</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">name_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># return the importance sorted descending</span>
        <span class="k">return</span> <span class="n">importance</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_name_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the feature name mapping of the TFT model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, str]</span>
<span class="sd">            The feature name mapping. For example</span>
<span class="sd">            {</span>
<span class="sd">                &#39;target_0&#39;: &#39;ice cream&#39;,</span>
<span class="sd">                &#39;past_covariate_0&#39;: &#39;heater&#39;,</span>
<span class="sd">                &#39;past_covariate_1&#39;: &#39;year&#39;,</span>
<span class="sd">                &#39;past_covariate_2&#39;: &#39;month&#39;,</span>
<span class="sd">                &#39;future_covariate_0&#39;: &#39;darts_enc_fc_cyc_month_sin&#39;,</span>
<span class="sd">                &#39;future_covariate_1&#39;: &#39;darts_enc_fc_cyc_month_cos&#39;,</span>
<span class="sd">             }</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">map_cols</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="n">comps</span> <span class="k">if</span> <span class="n">comps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">colname</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">map_cols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_components</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">map_cols</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">static_covariates_components</span><span class="p">,</span> <span class="s2">&quot;static_covariate&quot;</span><span class="p">,</span> <span class="s2">&quot;statcov&quot;</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="n">map_cols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">past_covariates_components</span><span class="p">,</span> <span class="s2">&quot;past_covariate&quot;</span><span class="p">,</span> <span class="s2">&quot;pastcov&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">map_cols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_covariates_components</span><span class="p">,</span> <span class="s2">&quot;future_covariate&quot;</span><span class="p">,</span> <span class="s2">&quot;futcov&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_plot_cov_selection</span><span class="p">(</span>
        <span class="n">importance</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Variable importance&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the variable importance of the TFT model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        importance</span>
<span class="sd">            The encoder / decoder importance.</span>
<span class="sd">        title</span>
<span class="sd">            The title of the plot.</span>
<span class="sd">        ax</span>
<span class="sd">            Optionally, an axis to plot on. Otherwise, will create and plot on a new axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">importance</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">importance</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Variable importance in %&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020 - 2023, Unit8 SA (Apache 2.0 License).<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>