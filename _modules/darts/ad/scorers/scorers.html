
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>darts.ad.scorers.scorers &#8212; darts  documentation</title>
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <link rel="shortcut icon" href="../../../../_static/docs-favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../../../index.html">
  <img src="../../../../_static/darts-logo-trim.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../README.html">
  Home
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../quickstart/00-quickstart.html">
  Quickstart
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../userguide.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../generated_api/darts.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../examples.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../release_notes/RELEASE_NOTES.html">
  Release Notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/unit8co/darts" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/unit8co" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for darts.ad.scorers.scorers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Scorers Base Classes</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># TODO:</span>
<span class="c1">#     - add stride for Scorers like Kmeans and Wasserstein</span>
<span class="c1">#     - add option to normalize the windows for kmeans? capture only the form and not the values.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">darts</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeries</span><span class="p">,</span> <span class="n">metrics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.ad.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_assert_same_length</span><span class="p">,</span>
    <span class="n">_check_input</span><span class="p">,</span>
    <span class="n">_sanity_check_two_series</span><span class="p">,</span>
    <span class="n">eval_metric_from_scores</span><span class="p">,</span>
    <span class="n">show_anomalies_from_scores</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">raise_log</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.metrics.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">METRIC_TYPE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.data.tabularization</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_lagged_data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.ts_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">series2seq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_build_tqdm_iterator</span><span class="p">,</span> <span class="n">_parallel_apply</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AnomalyScorer"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.AnomalyScorer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">AnomalyScorer</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all anomaly scorers&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_univariate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        is_univariate</span>
<span class="sd">            Whether the scorer is a univariate scorer.</span>
<span class="sd">        window</span>
<span class="sd">            Integer value indicating the size of the window W used by the scorer to transform the series into an</span>
<span class="sd">            anomaly score. A scorer will slice the given series into subsequences of size W and returns a value</span>
<span class="sd">            indicating how anomalous these subset of W values are. A post-processing step will convert this anomaly</span>
<span class="sd">            score into a point-wise anomaly score (see definition of `window_transform`). The window size should be</span>
<span class="sd">            commensurate to the expected durations of the anomalies one is looking for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">window</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">raise_log</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter `window` must be strictly greater than 0, found `</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">`.&quot;</span>
                <span class="p">),</span>
                <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_univariate</span> <span class="o">=</span> <span class="n">is_univariate</span>

<div class="viewcode-block" id="AnomalyScorer.score_from_prediction"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.AnomalyScorer.score_from_prediction">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">score_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">pred_series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the anomaly score on the two (sequence of) series.</span>

<span class="sd">        If a pair of sequences is given, they must contain the same number</span>
<span class="sd">        of series. The scorer will score each pair of series independently</span>
<span class="sd">        and return an anomaly score for each pair.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series:</span>
<span class="sd">            The (sequence of) actual series.</span>
<span class="sd">        pred_series</span>
<span class="sd">            The (sequence of) predicted series.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[TimeSeries, Sequence[TimeSeries]]</span>
<span class="sd">            (Sequence of) anomaly score time series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">called_with_single_series</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">)</span>
        <span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span> <span class="o">=</span> <span class="n">series2seq</span><span class="p">(</span><span class="n">series</span><span class="p">),</span> <span class="n">series2seq</span><span class="p">(</span><span class="n">pred_series</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">pred_name</span> <span class="o">=</span> <span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="s2">&quot;pred_series&quot;</span>
        <span class="n">_assert_same_length</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pred_name</span><span class="p">)</span>

        <span class="n">pred_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">actual</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">):</span>
            <span class="n">_sanity_check_two_series</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pred_name</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">slice_intersect_times</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_window_size</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_core_from_prediction</span><span class="p">(</span>
                <span class="n">vals</span><span class="o">=</span><span class="n">actual</span><span class="o">.</span><span class="n">slice_intersect_values</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span>
                <span class="n">pred_vals</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">slice_intersect_values</span><span class="p">(</span><span class="n">actual</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="n">scores</span><span class="p">,</span>
                <span class="n">times</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># apply a moving average with window size `self.window` to the anomaly scores starting at `self.window`;</span>
                <span class="c1"># series of length `n` will be transformed into a series of length `n-self.window+1`.</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span>
                    <span class="n">transforms</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;rolling&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;min_periods&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">treat_na</span><span class="o">=</span><span class="s2">&quot;dropna&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">pred_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">called_with_single_series</span> <span class="k">else</span> <span class="n">pred_scores</span></div>

<div class="viewcode-block" id="AnomalyScorer.eval_metric_from_prediction"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.AnomalyScorer.eval_metric_from_prediction">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">eval_metric_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">anomalies</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">pred_series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;AUC_ROC&quot;</span><span class="p">,</span> <span class="s2">&quot;AUC_PR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;AUC_ROC&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the anomaly score between `series` and `pred_series`, and returns the score</span>
<span class="sd">        of an agnostic threshold metric.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anomalies</span>
<span class="sd">            The (sequence of) ground truth binary anomaly series (`1` if it is an anomaly and `0` if not).</span>
<span class="sd">        series</span>
<span class="sd">            The (sequence of) actual series.</span>
<span class="sd">        pred_series</span>
<span class="sd">            The (sequence of) predicted series.</span>
<span class="sd">        metric</span>
<span class="sd">            The name of the metric function to use. Must be one of &quot;AUC_ROC&quot; (Area Under the</span>
<span class="sd">            Receiver Operating Characteristic Curve) and &quot;AUC_PR&quot; (Average Precision from scores).</span>
<span class="sd">            Default: &quot;AUC_ROC&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            A single metric value for a single univariate `series`.</span>
<span class="sd">        Sequence[float]</span>
<span class="sd">            A sequence of metric values for:</span>

<span class="sd">            - a single multivariate `series`.</span>
<span class="sd">            - a sequence of univariate `series`.</span>
<span class="sd">        Sequence[Sequence[float]]</span>
<span class="sd">            A sequence of sequences of metric values for a sequence of multivariate `series`.</span>
<span class="sd">            The outer sequence is over the series, and inner sequence is over the series&#39; components/columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_univariate_scorer</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>
        <span class="n">pred_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_from_prediction</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eval_metric_from_scores</span><span class="p">(</span>
            <span class="n">anomalies</span><span class="o">=</span><span class="n">anomalies</span><span class="p">,</span>
            <span class="n">pred_scores</span><span class="o">=</span><span class="n">pred_scores</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AnomalyScorer.show_anomalies_from_prediction"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.AnomalyScorer.show_anomalies_from_prediction">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">show_anomalies_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span>
        <span class="n">pred_series</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span>
        <span class="n">scorer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">anomalies</span><span class="p">:</span> <span class="n">TimeSeries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;AUC_ROC&quot;</span><span class="p">,</span> <span class="s2">&quot;AUC_PR&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">component_wise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the results of the scorer.</span>

<span class="sd">        Computes the anomaly score on the two series. And plots the results.</span>

<span class="sd">        The plot will be composed of the following:</span>
<span class="sd">            - the series and the pred_series.</span>
<span class="sd">            - the anomaly score of the scorer.</span>
<span class="sd">            - the actual anomalies, if given.</span>

<span class="sd">        It is possible to:</span>
<span class="sd">            - add a title to the figure with the parameter `title`</span>
<span class="sd">            - give personalized name to the scorer with `scorer_name`</span>
<span class="sd">            - show the results of a metric for the anomaly score (AUC_ROC or AUC_PR),</span>
<span class="sd">              if the actual anomalies is provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series</span>
<span class="sd">            The actual series to visualize anomalies from.</span>
<span class="sd">        pred_series</span>
<span class="sd">            The predicted series of `series`.</span>
<span class="sd">        anomalies</span>
<span class="sd">            The ground truth of the anomalies (1 if it is an anomaly and 0 if not)</span>
<span class="sd">        scorer_name</span>
<span class="sd">            Name of the scorer.</span>
<span class="sd">        title</span>
<span class="sd">            Title of the figure</span>
<span class="sd">        metric</span>
<span class="sd">            Optionally, the name of the metric function to use. Must be one of &quot;AUC_ROC&quot; (Area Under the</span>
<span class="sd">            Receiver Operating Characteristic Curve) and &quot;AUC_PR&quot; (Average Precision from scores).</span>
<span class="sd">            Default: &quot;AUC_ROC&quot;.</span>
<span class="sd">        component_wise</span>
<span class="sd">            If True, will separately plot each component in case of multivariate anomaly detection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="n">num_series_expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span>
            <span class="n">pred_series</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pred_series&quot;</span><span class="p">,</span> <span class="n">num_series_expected</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pred_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_from_prediction</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Anomaly results by scorer </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">scorer_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scorer_name</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;anomaly score by </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">show_anomalies_from_scores</span><span class="p">(</span>
            <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
            <span class="n">anomalies</span><span class="o">=</span><span class="n">anomalies</span><span class="p">,</span>
            <span class="n">pred_series</span><span class="o">=</span><span class="n">pred_series</span><span class="p">,</span>
            <span class="n">pred_scores</span><span class="o">=</span><span class="n">pred_scores</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
            <span class="n">names_of_scorers</span><span class="o">=</span><span class="n">scorer_name</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">component_wise</span><span class="o">=</span><span class="n">component_wise</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_probabilistic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the scorer expects a probabilistic prediction as the first input.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_univariate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the Scorer is a univariate scorer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_univariate</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_trainable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the scorer is trainable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the name of the scorer&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_score_core_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">pred_vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_univariate_scorer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">anomalies</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if `anomalies` contains only univariate series when the scorer has the</span>
<span class="sd">        parameter &#39;is_univariate&#39; set to True.</span>

<span class="sd">        &#39;is_univariate&#39; is:</span>
<span class="sd">            True -&gt; when the function of the scorer `score(series)` (or, if applicable,</span>
<span class="sd">                `score_from_prediction(series, pred_series)`) returns a univariate</span>
<span class="sd">                anomaly score regardless of the input `series` (or, if applicable, `series`</span>
<span class="sd">                and `pred_series`).</span>
<span class="sd">            False -&gt; when the scorer will return a series that has the</span>
<span class="sd">                same number of components as the input (can be univariate or multivariate).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_check_univariate</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Checks if `anomalies` contains only univariate series, which</span>
<span class="sd">            is required if any of the scorers returns a univariate score.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_univariate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">raise_log</span><span class="p">(</span>
                    <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Scorer </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> will return a univariate anomaly score series (width=1). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Found a multivariate `anomalies`. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;The evaluation of the accuracy cannot be computed between the two series.&quot;</span>
                    <span class="p">),</span>
                    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">anomalies</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;anomalies&quot;</span><span class="p">,</span> <span class="n">extra_checks</span><span class="o">=</span><span class="n">_check_univariate</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_window_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if the parameter window is less or equal than the length of the given series&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
            <span class="n">raise_log</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Window size </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="si">}</span><span class="s2"> is greater than the targeted series length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;must be lower or equal. Decrease the window size or increase the length series &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;input to score on.&quot;</span>
                <span class="p">),</span>
                <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_assert_stochastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name_series</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if the series is stochastic (number of samples is larger than one).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">raise_log</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Scorer </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> is expecting `</span><span class="si">{</span><span class="n">name_series</span><span class="si">}</span><span class="s2">` to be a stochastic &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;timeseries (number of samples must be higher than 1, found: </span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_deterministic_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span> <span class="n">name_series</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract a deterministic series from `series` (quantile=0.5 if `series` is probabilistic).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">is_deterministic</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">series</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Scorer </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> is expecting `</span><span class="si">{</span><span class="n">name_series</span><span class="si">}</span><span class="s2">` to be a (sequence of) deterministic &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;timeseries (number of samples must be equal to 1, found: </span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">). The series &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;will be converted to a deterministic series by taking the median of the samples.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_deterministic_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">name_series</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract deterministic values from `series` (quantile=0.5 if `series` is probabilistic).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">series</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Scorer </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> is expecting `</span><span class="si">{</span><span class="n">name_series</span><span class="si">}</span><span class="s2">` to be a (sequence of) deterministic &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;timeseries (number of samples must be equal to 1, found: </span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">). The series &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;will be converted to a deterministic series by taking the median of the samples.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="FittableAnomalyScorer"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.FittableAnomalyScorer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">FittableAnomalyScorer</span><span class="p">(</span><span class="n">AnomalyScorer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class of scorers that require training.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">is_univariate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">window_agg</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">diff_fn</span><span class="p">:</span> <span class="n">METRIC_TYPE</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">ae</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        is_univariate</span>
<span class="sd">            Whether the scorer is a univariate scorer.</span>
<span class="sd">        window</span>
<span class="sd">            Integer value indicating the size of the window W used by the scorer to transform the series into an</span>
<span class="sd">            anomaly score. A scorer will slice the given series into subsequences of size W and returns a value</span>
<span class="sd">            indicating how anomalous these subset of W values are. A post-processing step will convert this anomaly</span>
<span class="sd">            score into a point-wise anomaly score (see definition of `window_transform`). The window size should be</span>
<span class="sd">            commensurate to the expected durations of the anomalies one is looking for.</span>
<span class="sd">        window_agg</span>
<span class="sd">            Whether to transform/aggregate window-wise anomaly scores into a point-wise anomaly scores.</span>
<span class="sd">        diff_fn</span>
<span class="sd">            The differencing function to use to transform the predicted and actual series into one series.</span>
<span class="sd">            The scorer is then applied to this series. Must be one of Darts per-time-step metrics (e.g.,</span>
<span class="sd">            :func:`~darts.metrics.metrics.ae` for the absolute difference, :func:`~darts.metrics.metrics.err` for the</span>
<span class="sd">            difference, :func:`~darts.metrics.metrics.se` for the squared difference, ...).</span>
<span class="sd">            By default, uses the absolute difference (:func:`~darts.metrics.metrics.ae`).</span>
<span class="sd">        n_jobs</span>
<span class="sd">            The number of jobs to run in parallel. Parallel jobs are created only when a `Sequence[TimeSeries]` is</span>
<span class="sd">            passed as input, parallelising operations regarding different `TimeSeries`. Defaults to `1`</span>
<span class="sd">            (sequential). Setting the parameter to `-1` means using all the available processors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_univariate</span><span class="o">=</span><span class="n">is_univariate</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diff_fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">TIME_DEPENDENT_METRICS</span><span class="p">:</span>
            <span class="n">valid_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">TIME_DEPENDENT_METRICS</span><span class="p">]</span>
            <span class="n">raise_log</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;`diff_fn` must be one of Darts &#39;per time step&#39; metrics &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">valid_metrics</span><span class="si">}</span><span class="s2">. Found `</span><span class="si">{</span><span class="n">diff_fn</span><span class="si">}</span><span class="s2">`&quot;</span>
                <span class="p">),</span>
                <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_fn</span> <span class="o">=</span> <span class="n">diff_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_agg</span> <span class="o">=</span> <span class="n">window_agg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>

        <span class="c1"># indicates if the scorer has been trained yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_called</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width_trained_on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="FittableAnomalyScorer.fit"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.FittableAnomalyScorer.fit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the scorer on the given time series.</span>

<span class="sd">        If a sequence of series, the scorer is fitted on the concatenation of the sequence.</span>

<span class="sd">        The assumption is that `series` is generally anomaly-free.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series</span>
<span class="sd">            The (sequence of) series with no anomalies.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">            Fitted Scorer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">series2seq</span><span class="p">(</span><span class="n">series</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span>
            <span class="n">series</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">,</span>
            <span class="n">width_expected</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">extra_checks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_window_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width_trained_on</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_core</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_called</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FittableAnomalyScorer.fit_from_prediction"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.FittableAnomalyScorer.fit_from_prediction">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">pred_series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the scorer on the two (sequences of) series.</span>

<span class="sd">        The function `diff_fn` passed as a parameter to the scorer, will transform `pred_series` and `series`</span>
<span class="sd">        into one series. By default, `diff_fn` will compute the absolute difference (Default:</span>
<span class="sd">        :func:`~darts.metrics.metrics.ae`). If `pred_series` and `series` are sequences, `diff_fn` will be</span>
<span class="sd">        applied to all pairwise elements of the sequences.</span>

<span class="sd">        The scorer will then be fitted on this (sequence of) series. If a sequence of series is given,</span>
<span class="sd">        the scorer will be fitted on the concatenation of the sequence.</span>

<span class="sd">        The scorer assumes that the (sequence of) series is anomaly-free.</span>

<span class="sd">        If any of the series is stochastic (with `n_samples&gt;1`), `diff_fn` is computed on quantile `0.5`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series</span>
<span class="sd">            The (sequence of) actual series.</span>
<span class="sd">        pred_series</span>
<span class="sd">            The (sequence of) predicted series.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">            Fitted Scorer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="s2">&quot;series&quot;</span><span class="p">)</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">pred_series</span><span class="p">,</span> <span class="s2">&quot;pred_series&quot;</span><span class="p">)</span>
        <span class="n">diff_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diff_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">diff_series</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_called</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="FittableAnomalyScorer.score"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.FittableAnomalyScorer.score">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the anomaly score on the given series.</span>

<span class="sd">        If a sequence of series is given, the scorer will score each series independently</span>
<span class="sd">        and return an anomaly score for each series in the sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series</span>
<span class="sd">            The (sequence of) series to detect anomalies from.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[TimeSeries, Sequence[TimeSeries]]</span>
<span class="sd">            (Sequence of) anomaly score time series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_fit_called</span><span class="p">()</span>

        <span class="n">called_with_single_series</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span>
            <span class="n">series</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="n">extra_checks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_window_size</span>
        <span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_deterministic_series</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;series&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span><span class="p">]</span>

        <span class="n">pred_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_core</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">called_with_single_series</span> <span class="k">else</span> <span class="n">pred_scores</span></div>

<div class="viewcode-block" id="FittableAnomalyScorer.score_from_prediction"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.FittableAnomalyScorer.score_from_prediction">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">score_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">pred_series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the anomaly score on the two (sequence of) series.</span>

<span class="sd">        The function `diff_fn` passed as a parameter to the scorer, will transform `pred_series` and `series`</span>
<span class="sd">        into one &quot;difference&quot; series. By default, `diff_fn` will compute the absolute difference</span>
<span class="sd">        (Default: :func:`~darts.metrics.metrics.ae`).</span>
<span class="sd">        If series and pred_series are sequences, `diff_fn` will be applied to all pairwise elements</span>
<span class="sd">        of the sequences.</span>

<span class="sd">        The scorer will then transform this series into an anomaly score. If a sequence of series is given,</span>
<span class="sd">        the scorer will score each series independently and return an anomaly score for each series in the sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series</span>
<span class="sd">            The (sequence of) actual series.</span>
<span class="sd">        pred_series</span>
<span class="sd">            The (sequence of) predicted series.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[TimeSeries, Sequence[TimeSeries]]</span>
<span class="sd">            (Sequence of) anomaly score time series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_fit_called</span><span class="p">()</span>

        <span class="n">called_with_single_series</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="s2">&quot;series&quot;</span><span class="p">)</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">pred_series</span><span class="p">,</span> <span class="s2">&quot;pred_series&quot;</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diff_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">)</span>
        <span class="n">pred_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">called_with_single_series</span> <span class="k">else</span> <span class="n">pred_scores</span></div>

<div class="viewcode-block" id="FittableAnomalyScorer.eval_metric"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.FittableAnomalyScorer.eval_metric">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">eval_metric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">anomalies</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]],</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;AUC_ROC&quot;</span><span class="p">,</span> <span class="s2">&quot;AUC_PR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;AUC_ROC&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the anomaly score of the given time series, and returns the score</span>
<span class="sd">        of an agnostic threshold metric.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anomalies</span>
<span class="sd">            The (sequence of) ground truth binary anomaly series (`1` if it is an anomaly and `0` if not).</span>
<span class="sd">        series</span>
<span class="sd">            The (sequence of) series to detect anomalies from.</span>
<span class="sd">        metric</span>
<span class="sd">            The name of the metric function to use. Must be one of &quot;AUC_ROC&quot; (Area Under the</span>
<span class="sd">            Receiver Operating Characteristic Curve) and &quot;AUC_PR&quot; (Average Precision from scores).</span>
<span class="sd">            Default: &quot;AUC_ROC&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            A single score/metric for univariate `series` series (with only one component/column).</span>
<span class="sd">        Sequence[float]</span>
<span class="sd">            A sequence (list) of scores for:</span>

<span class="sd">            - multivariate `series` series (multiple components). Gives a score for each component.</span>
<span class="sd">            - a sequence (list) of univariate `series` series. Gives a score for each series.</span>
<span class="sd">        Sequence[Sequence[float]]</span>
<span class="sd">            A sequence of sequences of scores for a sequence of multivariate `series` series.</span>
<span class="sd">            Gives a score for each series (outer sequence) and component (inner sequence).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="n">series2seq</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_univariate_scorer</span><span class="p">(</span><span class="n">anomalies</span><span class="p">)</span>
        <span class="n">pred_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_agg</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span>
        <span class="k">return</span> <span class="n">eval_metric_from_scores</span><span class="p">(</span>
            <span class="n">anomalies</span><span class="o">=</span><span class="n">anomalies</span><span class="p">,</span>
            <span class="n">pred_scores</span><span class="o">=</span><span class="n">pred_scores</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FittableAnomalyScorer.show_anomalies"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.FittableAnomalyScorer.show_anomalies">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">show_anomalies</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">TimeSeries</span><span class="p">,</span>
        <span class="n">anomalies</span><span class="p">:</span> <span class="n">TimeSeries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scorer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;AUC_ROC&quot;</span><span class="p">,</span> <span class="s2">&quot;AUC_PR&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">component_wise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the results of the scorer.</span>

<span class="sd">        Computes the score on the given series input. And plots the results.</span>

<span class="sd">        The plot will be composed of the following:</span>
<span class="sd">            - the series itself.</span>
<span class="sd">            - the anomaly score of the score.</span>
<span class="sd">            - the actual anomalies, if given.</span>

<span class="sd">        It is possible to:</span>
<span class="sd">            - add a title to the figure with the parameter `title`</span>
<span class="sd">            - give personalized name to the scorer with `scorer_name`</span>
<span class="sd">            - show the results of a metric for the anomaly score (AUC_ROC or AUC_PR),</span>
<span class="sd">            if the actual anomalies is provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series</span>
<span class="sd">            The series to visualize anomalies from.</span>
<span class="sd">        anomalies</span>
<span class="sd">            The (sequence of) ground truth binary anomaly series (`1` if it is an anomaly and `0` if not).</span>
<span class="sd">        scorer_name</span>
<span class="sd">            Name of the scorer.</span>
<span class="sd">        title</span>
<span class="sd">            Title of the figure</span>
<span class="sd">        metric</span>
<span class="sd">            Optionally, the name of the metric function to use. Must be one of &quot;AUC_ROC&quot; (Area Under the</span>
<span class="sd">            Receiver Operating Characteristic Curve) and &quot;AUC_PR&quot; (Average Precision from scores).</span>
<span class="sd">            Default: &quot;AUC_ROC&quot;.</span>
<span class="sd">        component_wise</span>
<span class="sd">            If True, will separately plot each component in case of multivariate anomaly detection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="n">num_series_expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pred_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Anomaly results by scorer </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">scorer_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scorer_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;anomaly score by </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_agg</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span>

        <span class="k">return</span> <span class="n">show_anomalies_from_scores</span><span class="p">(</span>
            <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
            <span class="n">anomalies</span><span class="o">=</span><span class="n">anomalies</span><span class="p">,</span>
            <span class="n">pred_scores</span><span class="o">=</span><span class="n">pred_scores</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
            <span class="n">names_of_scorers</span><span class="o">=</span><span class="n">scorer_name</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">component_wise</span><span class="o">=</span><span class="n">component_wise</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_trainable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the Scorer is trainable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_fit_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_score_core</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_score_core_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">pred_vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_diff_series</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span>
        <span class="n">pred_series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the `diff_fn` to two sequences of time series. Converts two time series into 1.</span>

<span class="sd">        Each series-pair in series and pred_series must:</span>
<span class="sd">            - have a non-empty time intersection</span>
<span class="sd">            - be of the same width W</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series</span>
<span class="sd">            A sequence of time series</span>
<span class="sd">        pred_series</span>
<span class="sd">            A sequence of predicted time series to compute `diff_fn` on.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Sequence[TimeSeries]</span>
<span class="sd">            A sequence of series of width W from the difference between `series` and `pred_series`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_fn</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">,</span> <span class="n">component_reduction</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pred_series</span><span class="p">,</span> <span class="n">residuals</span><span class="p">):</span>
            <span class="n">time_index</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">slice_intersect_times</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TimeSeries</span><span class="p">(</span>
                    <span class="n">times</span><span class="o">=</span><span class="n">time_index</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                    <span class="n">components</span><span class="o">=</span><span class="n">s2</span><span class="o">.</span><span class="n">components</span><span class="p">,</span>
                    <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">s2</span><span class="o">.</span><span class="n">_attrs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fun_window_agg</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms a window-wise anomaly score into a point-wise anomaly score.</span>

<span class="sd">        When using a window of size `W`, a scorer will return an anomaly score</span>
<span class="sd">        with values that represent how anomalous each past `W` is. If the parameter</span>
<span class="sd">        `window_agg` is set to `True` (default value), the scores for each point</span>
<span class="sd">        can be assigned by aggregating the anomaly scores for each window the point</span>
<span class="sd">        is included in.</span>

<span class="sd">        This post-processing step is equivalent to a rolling average of length window</span>
<span class="sd">        over the anomaly score series. The return anomaly score represents the abnormality</span>
<span class="sd">        of each timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: can we use window_transform here?</span>
        <span class="n">scores_point_wise</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
            <span class="n">score_vals</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">all_values</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">score_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx_point</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)):</span>
                <span class="c1"># &quot;look ahead window&quot; to account for the &quot;look behind window&quot; of the scorer</span>
                <span class="n">mean_score</span><span class="p">[</span><span class="n">idx_point</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_vals</span><span class="p">[</span><span class="n">idx_point</span> <span class="p">:</span> <span class="n">idx_point</span> <span class="o">+</span> <span class="n">window</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="n">score_point_wise</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span>
                <span class="n">times</span><span class="o">=</span><span class="n">score</span><span class="o">.</span><span class="n">time_index</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="n">mean_score</span><span class="p">,</span>
                <span class="n">components</span><span class="o">=</span><span class="n">score</span><span class="o">.</span><span class="n">components</span><span class="p">,</span>
                <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">score</span><span class="o">.</span><span class="n">_attrs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">scores_point_wise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_point_wise</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores_point_wise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_fit_called</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if the scorer has been fitted before calling its `score()` function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_called</span><span class="p">:</span>
            <span class="n">raise_log</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The Scorer </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> has not been fitted yet. Call `fit()` first.&quot;</span>
                <span class="p">),</span>
                <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="WindowedAnomalyScorer"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.WindowedAnomalyScorer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">WindowedAnomalyScorer</span><span class="p">(</span><span class="n">FittableAnomalyScorer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for anomaly scorers that rely on windows to detect anomalies&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">is_univariate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">window_agg</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">diff_fn</span><span class="p">:</span> <span class="n">METRIC_TYPE</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        is_univariate</span>
<span class="sd">            Whether the scorer is a univariate scorer. If `True` and when using multivariate series, the scores are</span>
<span class="sd">            computed on the concatenated components/columns in the considered window to compute one score.</span>
<span class="sd">        window</span>
<span class="sd">            Integer value indicating the size of the window W used by the scorer to transform the series into an</span>
<span class="sd">            anomaly score. A scorer slices the given series into subsequences of size W and returns a value</span>
<span class="sd">            indicating how anomalous these subsets of W values are. A post-processing step will convert the anomaly</span>
<span class="sd">            scores into point-wise anomaly scores (see definition of `window_transform`). The window size should be</span>
<span class="sd">            commensurate to the expected durations of the anomalies one is looking for.</span>
<span class="sd">        window_agg</span>
<span class="sd">            Whether to transform/aggregate window-wise anomaly scores into point-wise anomaly scores.</span>
<span class="sd">        diff_fn</span>
<span class="sd">            The differencing function to use to transform the predicted and actual series into one series.</span>
<span class="sd">            The scorer is then applied to this series. Must be one of Darts per-time-step metrics (e.g.,</span>
<span class="sd">            :func:`~darts.metrics.metrics.ae` for the absolute difference, :func:`~darts.metrics.metrics.err` for the</span>
<span class="sd">            difference, :func:`~darts.metrics.metrics.se` for the squared difference, ...).</span>
<span class="sd">            By default, uses the absolute difference (:func:`~darts.metrics.metrics.ae`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">is_univariate</span><span class="o">=</span><span class="n">is_univariate</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
            <span class="n">window_agg</span><span class="o">=</span><span class="n">window_agg</span><span class="p">,</span>
            <span class="n">diff_fn</span><span class="o">=</span><span class="n">diff_fn</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_model_score_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper around model inference method&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fit_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train one sub-model for each component when self.is_univariate=False and series is multivariate&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_univariate</span> <span class="ow">or</span> <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabularize_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">component_wise</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">tabular_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabularize_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">component_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># parallelize fitting of the component-wise models</span>
        <span class="n">fit_iterator</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tabular_data</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tabular_data</span><span class="p">))</span>
        <span class="n">input_iterator</span> <span class="o">=</span> <span class="n">_build_tqdm_iterator</span><span class="p">(</span>
            <span class="n">fit_iterator</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">tabular_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">_parallel_apply</span><span class="p">(</span>
            <span class="n">input_iterator</span><span class="p">,</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">,</span>
            <span class="n">fn_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_score_core</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the scorer (sub) model scoring method on the series components&quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">_check_input</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="n">width_expected</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">width_trained_on</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_univariate</span> <span class="ow">or</span> <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># n series * (time, components, samples) -&gt; (n series * (time - (window - 1)),)</span>
            <span class="n">score_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_score_method</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabularize_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">component_wise</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># (n series * (time - (window - 1)),) -&gt; (components=1, n series * (time - (window - 1)))</span>
            <span class="n">score_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">score_vals</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># parallelize scoring of components by the corresponding sub-model</span>
            <span class="n">score_iterator</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tabularize_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">component_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">input_iterator</span> <span class="o">=</span> <span class="n">_build_tqdm_iterator</span><span class="p">(</span>
                <span class="n">score_iterator</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># n series * (time, components, samples) -&gt; (components, n series * (time - (window - 1)))</span>
            <span class="n">score_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">_parallel_apply</span><span class="p">(</span>
                    <span class="n">input_iterator</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model_score_method</span><span class="p">,</span>
                    <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">,</span>
                    <span class="n">fn_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                    <span class="n">fn_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># (components, n series * (time - (window - 1))) -&gt; n series * (time - (window - 1), components)</span>
        <span class="n">score_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_tabular_to_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">score_vals</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_agg</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun_window_agg</span><span class="p">(</span><span class="n">score_series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">score_series</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tabularize_series</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">component_wise</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal function called by WindowedAnomalyScorer `fit()` and `score()` functions.</span>

<span class="sd">        Transforms a sequence of series into tabular data of size window `W`. The parameter `component_wise`</span>
<span class="sd">        indicates how the rolling window must treat the different components if the series is multivariate.</span>
<span class="sd">        If set to `False`, the rolling window will be done on each component independently. If set to `True`,</span>
<span class="sd">        the `N` components will be concatenated to create windows of size `W` * `N`. The resulting tabular</span>
<span class="sd">        data of each series are concatenated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            For `component_wise=True`, an array of shape (components, time - (window - 1), window).</span>
<span class="sd">            The component dimension is in first place for easy parallelization over all component-wise models.</span>
<span class="sd">            For `component_wise=False`, an array of shape (time - (window - 1), window * components).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># n series * (time, components, sample) -&gt; (time - (window - 1), window * components)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">create_lagged_data</span><span class="p">(</span>
            <span class="n">target_series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
            <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
            <span class="n">uses_static_covariates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_training</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">concatenate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># bring into required model input shape</span>
        <span class="k">if</span> <span class="n">component_wise</span><span class="p">:</span>
            <span class="c1"># (time - (window - 1), window * components) -&gt; (time - (window - 1), window, components)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="c1"># (time - (window - 1), window, components) -&gt; (components, time - (window - 1), window)</span>
            <span class="n">d_time</span><span class="p">,</span> <span class="n">d_wind</span><span class="p">,</span> <span class="n">d_comp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">d_time</span><span class="p">,</span> <span class="n">d_comp</span><span class="p">],</span> <span class="p">[</span><span class="n">d_wind</span><span class="p">,</span> <span class="n">d_time</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_tabular_to_series</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">],</span> <span class="n">score_vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TimeSeries</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts generated anomaly score from `np.ndarray` into a sequence of series. For efficiency reasons,</span>
<span class="sd">        the anomaly scores were computed in one go (for each component if `component_wise=True`). If a list of series</span>
<span class="sd">        is given, each series will be concatenated by its components. The function aims to split the anomaly score at</span>
<span class="sd">        the proper indexes to create an anomaly score for each series.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_univariate</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_univariate</span> <span class="ow">and</span> <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># number of input components matches output components, we can generate a new series</span>
            <span class="c1"># with the same attrs, and component names</span>
            <span class="n">keep_components</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise, create a clean new series</span>
            <span class="n">keep_components</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># (components, n series * (time - (window - 1))) -&gt; (n series * (time - (window - 1)), components)</span>
        <span class="n">score_vals</span> <span class="o">=</span> <span class="n">score_vals</span><span class="o">.</span><span class="n">T</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># (n series * (time - (window - 1)), components) -&gt; n series * (time - (window - 1), components)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">components</span><span class="p">,</span> <span class="o">**</span><span class="n">s</span><span class="o">.</span><span class="n">_attrs</span><span class="p">}</span> <span class="k">if</span> <span class="n">keep_components</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TimeSeries</span><span class="p">(</span>
                    <span class="n">times</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">_time_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:],</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">score_vals</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="NLLScorer"><a class="viewcode-back" href="../../../../generated_api/darts.ad.scorers.scorers.html#darts.ad.scorers.scorers.NLLScorer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">NLLScorer</span><span class="p">(</span><span class="n">AnomalyScorer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parent class for all LikelihoodScorer&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        window</span>
<span class="sd">            Integer value indicating the size of the window W used by the scorer to transform the series into an</span>
<span class="sd">            anomaly score. A scorer will slice the given series into subsequences of size W and returns a value</span>
<span class="sd">            indicating how anomalous these subset of W values are. A post-processing step will convert this anomaly</span>
<span class="sd">            score into a point-wise anomaly score (see definition of `window_transform`). The window size should be</span>
<span class="sd">            commensurate to the expected durations of the anomalies one is looking for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_univariate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_probabilistic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_score_core_from_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">pred_vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each timestamp of the inputs:</span>

<span class="sd">        - the parameters of the considered distribution are fitted on the samples of the probabilistic time series</span>
<span class="sd">        - the negative log-likelihood of the deterministic time series values are computed</span>

<span class="sd">        If the series is multivariate, the score will be computed on each component independently.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vals</span>
<span class="sd">            The values of a deterministic time series (number of samples per timestamp must be equal to 1)</span>
<span class="sd">        pred_vals</span>
<span class="sd">            The values of a probabilistic time series (number of samples per timestamp must be higher than 1)</span>
<span class="sd">        time_index</span>
<span class="sd">            The time index intersection between `series` and `pred_series`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TimeSeries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_deterministic_values</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="s2">&quot;series&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_stochastic</span><span class="p">(</span><span class="n">pred_vals</span><span class="p">,</span> <span class="s2">&quot;pred_series&quot;</span><span class="p">)</span>

        <span class="n">np_anomaly_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">np_anomaly_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_score_core_nllikelihood</span><span class="p">(</span>
                    <span class="n">vals</span><span class="p">[:,</span> <span class="n">component_idx</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">pred_vals</span><span class="p">[:,</span> <span class="n">component_idx</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np_anomaly_scores</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_score_core_nllikelihood</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pred_vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each timestamp, the corresponding distribution is fitted on the probabilistic time-series</span>
<span class="sd">        input_2, and returns the negative log-likelihood of the deterministic time-series input_1</span>
<span class="sd">        given the distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020 - 2025, Unit8 SA (Apache 2.0 License).<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.0.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>