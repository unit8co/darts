
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Ensembling Models &#8212; darts  documentation</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../_static/docs-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Filtering and predicting using the darts filters" href="10-Kalman-filter-examples.html" />
    <link rel="prev" title="Time Series Mixer (TSMixer)" href="21-TSMixer-examples.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/darts-logo-trim.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../README.html">
  Home
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../quickstart/00-quickstart.html">
  Quickstart
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../userguide.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../generated_api/darts.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../examples.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../release_notes/RELEASE_NOTES.html">
  Release Notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/unit8co/darts" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/unit8co" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01-multi-time-series-and-covariates.html">
   Multiple Time Series, Pre-trained Models and Covariates
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="02-data-processing.html">
   Data (pre) processing using
   <code class="docutils literal notranslate">
    <span class="pre">
     DataTransformer
    </span>
   </code>
   and
   <code class="docutils literal notranslate">
    <span class="pre">
     Pipeline
    </span>
   </code>
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="15-static-covariates.html">
   Static Covariates
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="14-transfer-learning.html">
   Transfer Learning for Time Series Forecasting with Darts
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="16-hierarchical-reconciliation.html">
   Hierarchical Reconciliation - Example on the Australian Tourism Dataset
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="17-hyperparameter-optimization.html">
   Hyper-parameters Optimization for Electricity Load Forecasting
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="20-SKLearnModel-examples.html">
   Regression Models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="24-SKLearnClassifierModel-examples.html">
   Classification Models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="23-Conformal-Prediction-examples.html">
   Conformal Prediction Models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="03-FFT-examples.html">
   Fast Fourier Transform Forecasting Model (FFT)
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="04-RNN-examples.html">
   Recurrent Neural Networks Models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="05-TCN-examples.html">
   Temporal Convolutional Network
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="06-Transformer-examples.html">
   Transformer Model
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="07-NBEATS-examples.html">
   N-BEATS
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="08-DeepAR-examples.html">
   Probabilistic RNN
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="09-DeepTCN-examples.html">
   DeepTCN model
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="13-TFT-examples.html">
   Temporal Fusion Transformer
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="18-TiDE-examples.html">
   TimeSeries Deep Encoder
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="21-TSMixer-examples.html">
   Time Series Mixer (TSMixer)
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Ensembling Models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="10-Kalman-filter-examples.html">
   Filtering and predicting using the darts filters
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="11-GP-filter-examples.html">
   Filtering and predicting using the Gaussian Process filter
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="22-anomaly-detection-examples.html">
   Anomaly Detection Darts Module
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="12-Dynamic-Time-Warping-example.html">
   Dynamic Time Warping (DTW)
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Basics-&amp;-references">
   Basics &amp; references
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Naive-Ensembling">
   Naive Ensembling
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Using-covariates-&amp;-predicting-multivariate-series">
     Using covariates &amp; predicting multivariate series
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Probabilistic-naive-ensembling">
     Probabilistic naive ensembling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Learned-Ensembling">
   Learned Ensembling
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Training-using-historical-forecasts">
     Training using historical forecasts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Probabilistic-regression-ensemble">
     Probabilistic regression ensemble
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Bootstrapping-regression-ensemble">
     Bootstrapping regression ensemble
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Pre-trained-Ensembling">
     Pre-trained Ensembling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Conclusion">
   Conclusion
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Ensembling-Models">
<h1>Ensembling Models<a class="headerlink" href="#Ensembling-Models" title="Permalink to this heading">¶</a></h1>
<p>The following is a brief demonstration of the ensemble models in Darts. Starting from the examples provided in the <a class="reference external" href="https://unit8co.github.io/darts/quickstart/00-quickstart.html">Quickstart Notebook</a>, some advanced features and subtilities will be detailed.</p>
<p>The following topics are covered in this notebook : * <a class="reference external" href="#Basics-&amp;-references">Basics &amp; references</a> * <a class="reference external" href="#naive-ensembling">Naive Ensembling</a> * <a class="reference external" href="#naive-ensembling">Deterministic</a> * <a class="reference external" href="#using-covariates--predicting-multivariate-series">Covariates &amp; multivariate series</a> * <a class="reference external" href="#probabilistic-naive-ensembling">Probabilistic</a> * <a class="reference external" href="#learned-ensembling">Learned Ensembling</a> * <a class="reference external" href="#learned-ensembling">Deterministic</a> * <a class="reference external" href="#probabilistic-regression-ensemble">Probabilistic</a> *
<a class="reference external" href="#bootstrapping-regression-ensemble">Bootstraping</a> * <a class="reference external" href="#pre-trained-ensembling">Pre-trained Ensembling</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># fix python path if working locally</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">fix_pythonpath_if_working_locally</span>

<span class="n">fix_pythonpath_if_working_locally</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">darts.dataprocessing.transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AirPassengersDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExponentialSmoothing</span><span class="p">,</span>
    <span class="n">KalmanForecaster</span><span class="p">,</span>
    <span class="n">LinearRegressionModel</span><span class="p">,</span>
    <span class="n">NaiveDrift</span><span class="p">,</span>
    <span class="n">NaiveEnsembleModel</span><span class="p">,</span>
    <span class="n">NaiveSeasonal</span><span class="p">,</span>
    <span class="n">RandomForestModel</span><span class="p">,</span>
    <span class="n">RegressionEnsembleModel</span><span class="p">,</span>
    <span class="n">TCNModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.timeseries_generation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime_attribute_timeseries</span> <span class="k">as</span> <span class="n">dt_attr</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Basics-&amp;-references">
<h2>Basics &amp; references<a class="headerlink" href="#Basics-&-references" title="Permalink to this heading">¶</a></h2>
<p>Ensembling combines the forecasts of several “weak” models to obtain a more robust and accurate model.</p>
<p>All of Darts’ ensembling models rely on the <strong>stacking technique</strong> (<a class="reference external" href="https://machinelearningmastery.com/essence-of-stacking-ensembles-for-machine-learning/">reference</a>). They provide the same functionalities as the other forecasting models. Depending on the ensembled models, they can:</p>
<ul class="simple">
<li><p>levarage covariates</p></li>
<li><p>be trained on multiple-series</p></li>
<li><p>predict multivariate targets</p></li>
<li><p>generate probabilistic forecasts</p></li>
<li><p>and more…</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># using the AirPassenger dataset, directly available in darts</span>
<span class="n">ts_air</span> <span class="o">=</span> <span class="n">AirPassengersDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: xlabel=&#39;Month&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_4_1.png" src="../_images/examples_19-EnsembleModel-examples_4_1.png" />
</div>
</div>
</section>
<section id="Naive-Ensembling">
<h2>Naive Ensembling<a class="headerlink" href="#Naive-Ensembling" title="Permalink to this heading">¶</a></h2>
<p>Naive ensembling simply takes the average (mean) of the forecasts generated by the ensembled forecasting models. Darts’ <code class="docutils literal notranslate"><span class="pre">NaiveEnsembleModel</span></code> accepts both local and global forecasting models (as well as combination of the two, with some additional limitations).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">naive_ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">NaiveSeasonal</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">NaiveDrift</span><span class="p">()]</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">naive_ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (naive) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NaiveEnsemble (naive) MAPE: 11.87818
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_6_1.png" src="../_images/examples_19-EnsembleModel-examples_6_1.png" />
</div>
</div>
<p><strong>Note</strong>: after looking at the each model’s MAPE, one would notice that <code class="docutils literal notranslate"><span class="pre">NaiveSeasonal</span></code> is actually performing better on its own than ensembled with <code class="docutils literal notranslate"><span class="pre">NaiveDrift</span></code>. Checking the performance of the single models is in general a good practice before defining an ensemble.</p>
<p>Before creating the new <code class="docutils literal notranslate"><span class="pre">NaiveEnsemble</span></code>, we will screen models to identify which ones would do well together. The candidates are : - <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> : classic and simple model - <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code> : moving window model - <code class="docutils literal notranslate"><span class="pre">KalmanForecaster</span></code> : a filter-based model - <code class="docutils literal notranslate"><span class="pre">RandomForestModel</span></code> : decision trees model</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">candidates_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;LinearRegression&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">LinearRegressionModel</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;lags&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}),</span>
    <span class="s2">&quot;ExponentialSmoothing&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">ExponentialSmoothing</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="s2">&quot;KalmanForecaster&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">KalmanForecaster</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dim_x&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}),</span>
    <span class="s2">&quot;RandomForestModel&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">RandomForestModel</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;lags&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;random_state&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}),</span>
<span class="p">}</span>

<span class="n">backtest_models</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="p">(</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidates_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
    <span class="n">backtest_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> MAPE: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">ts_air</span><span class="p">),</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LinearRegression MAPE: 4.64008
ExponentialSmoothing MAPE: 4.44774
KalmanForecaster MAPE: 4.5539
RandomForestModel MAPE: 8.02264
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fix</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">backtest</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">backtest_models</span><span class="p">,</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">candidates_models</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<span class="p">):</span>
    <span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_9_0.png" src="../_images/examples_19-EnsembleModel-examples_9_0.png" />
</div>
</div>
<p>The historical forecasts obtained with the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> and <code class="docutils literal notranslate"><span class="pre">KalmanForecaster</span></code> look quite similar whereas <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code> tends to understimate the true values and <code class="docutils literal notranslate"><span class="pre">RandomForestModel</span></code> is failing to capture the peaks. To benefits from the ensemble, we will favor diversity and continue with the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> and <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code>.£</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()]</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (v2) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NaiveEnsemble (v2) MAPE: 4.04297
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_11_1.png" src="../_images/examples_19-EnsembleModel-examples_11_1.png" />
</div>
</div>
<p>Compared to the individual model MAPE score, 4.64008 for the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> and 4.44874 for the <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code>, the ensembling improved the accuracy to 4.04297!</p>
<section id="Using-covariates-&amp;-predicting-multivariate-series">
<h3>Using covariates &amp; predicting multivariate series<a class="headerlink" href="#Using-covariates-&-predicting-multivariate-series" title="Permalink to this heading">¶</a></h3>
<p>Depending on the forecasting models used, the <code class="docutils literal notranslate"><span class="pre">EnsembleModel</span></code> can of course also leverage covariates or forecast multivariates series! The covariates will be passed only to the forecasting models supporting them.</p>
<p>In the example below, the <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code> model does not support any covariates whereas the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> model supports <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">([</span>
    <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lags_future_covariates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="n">ExponentialSmoothing</span><span class="p">(),</span>
<span class="p">])</span>

<span class="c1"># encoding the months as integer, normalised</span>
<span class="n">future_cov</span> <span class="o">=</span> <span class="n">dt_attr</span><span class="p">(</span><span class="n">ts_air</span><span class="o">.</span><span class="n">time_index</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">add_length</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">future_covariates</span><span class="o">=</span><span class="n">future_cov</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (w/ future covariates) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NaiveEnsemble (w/ future covariates) MAPE: 4.07502
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_13_1.png" src="../_images/examples_19-EnsembleModel-examples_13_1.png" />
</div>
</div>
</section>
<section id="Probabilistic-naive-ensembling">
<h3>Probabilistic naive ensembling<a class="headerlink" href="#Probabilistic-naive-ensembling" title="Permalink to this heading">¶</a></h3>
<p>Combining models supporting probabilistic forecasts results in a probabilistic <code class="docutils literal notranslate"><span class="pre">NaiveEnsembleModel</span></code>! We can easily tweak the models used above to make them probabilistic and obtain confidence interval in ours forecasts:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble_probabilistic</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span>
            <span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">likelihood</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">ExponentialSmoothing</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># must pass num_samples &gt; 1 to obtain a probabilistic forecasts</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble_probabilistic</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span>
<span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: xlabel=&#39;time&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_15_1.png" src="../_images/examples_19-EnsembleModel-examples_15_1.png" />
</div>
</div>
</section>
</section>
<section id="Learned-Ensembling">
<h2>Learned Ensembling<a class="headerlink" href="#Learned-Ensembling" title="Permalink to this heading">¶</a></h2>
<p>Ensembling can also be considered as a supervised regression problem: given a set of forecasts (features), find a model that combines them in order to minimise errors on the target. This is what the <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> does. The main three parameters are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">forecasting_models</span></code> is a list of forecasting models whose predictions we want to ensemble.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_train_n_points</span></code> is the number of time steps to use for fitting the “ensemble regression” model (i.e., the inner model that combines the forecasts).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model</span></code> is, optionally, a sklearn-compatible regression model or a Darts <code class="docutils literal notranslate"><span class="pre">SKLearnModel</span></code> to be used for the ensemble regression. If not specified, Darts’ <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> is used. Using a sklearn model is easy out-of-the-box, but using one of Darts’ regression models allows to potentially take arbitrary lags of the individual forecasts as inputs of the regression model.</p></li>
</ul>
<p>Once these elements are in place, a <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> can be used like a regular forecasting model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble_model</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">NaiveSeasonal</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">NaiveDrift</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble_model</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (naive) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (naive) MAPE: 4.85142
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_17_1.png" src="../_images/examples_19-EnsembleModel-examples_17_1.png" />
</div>
</div>
<p>Compared to the MAPE of 11.87818 obtained at the beginning of the <a class="reference external" href="#Naive-ensembling">naive ensembling section</a>, adding a <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> on top of the two naive models does improve the quality of the forecast.</p>
<p>Now, let’s see if we can observe similar gain when the <code class="docutils literal notranslate"><span class="pre">RegressionEnsemble</span></code> forecasting models are not naive:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (v2) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (v2) MAPE: 4.63334
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_19_1.png" src="../_images/examples_19-EnsembleModel-examples_19_1.png" />
</div>
</div>
<p>Interestingly, even if the MAPE improved compared to the <code class="docutils literal notranslate"><span class="pre">RegressionEnsemble</span></code> relying on naive models (MAPE: 4.85142), it does not outperform the <code class="docutils literal notranslate"><span class="pre">NaiveEnsemble</span></code> using similar forecasting models (MAPE: 4.04297).</p>
<p>This performance gap is partially caused by the points set aside to train the ensembling <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code>; the two forecasting models (<code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> and <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code>) cannot access the latest values of the series, which contains a marked upward trend.</p>
<p>Out of curiosity, we can use the <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> regression model from the sklearn library to ensemble the forecasts:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ridge</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">regression_model</span><span class="o">=</span><span class="n">Ridge</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (Ridge) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (Ridge) MAPE: 6.46803
</pre></div></div>
</div>
<p>In this particuliar scenario, using a regression model with a regularization term deteriorated the forecasts but there might be other cases where it will improve them.</p>
<section id="Training-using-historical-forecasts">
<h3>Training using historical forecasts<a class="headerlink" href="#Training-using-historical-forecasts" title="Permalink to this heading">¶</a></h3>
<p>When predicting a number of values greater than their <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>, <code class="docutils literal notranslate"><span class="pre">GlobalForecastingModels</span></code> rely on auto-regression (use their own output as input) to forecast values far in the future. However, the quality of the forecasts can considerably decrease as the predicted timestamp get further from the end of the observations. During <code class="docutils literal notranslate"><span class="pre">RegressionEnsemble</span></code>’s regression model training, the forecasting models generate forecasts for timestamps where the ground truth is actually known and
available, making it possible to use <code class="docutils literal notranslate"><span class="pre">historical_forecasts</span></code> instead of <code class="docutils literal notranslate"><span class="pre">predict()</span></code>.</p>
<p>This can be activated with <code class="docutils literal notranslate"><span class="pre">train_using_historical_forecasts=True</span></code>.</p>
<p>Under the hood, the ensemble model will trigger historical forecasting for each model with <code class="docutils literal notranslate"><span class="pre">forecast_horizon=model.output_chunk_length</span></code>, <code class="docutils literal notranslate"><span class="pre">stride=model.output_chunk_length</span></code>, <code class="docutils literal notranslate"><span class="pre">last_points_only=False</span></code>, and <code class="docutils literal notranslate"><span class="pre">overlap_end=False</span></code> to predict the last <code class="docutils literal notranslate"><span class="pre">regression_train_n_points</span></code> points of the target series.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># replacing the ExponentialSmoothing (local) with RandomForestModel (global)</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">RandomForestModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">train_using_historical_forecasts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ensemble_hist_fct</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">RandomForestModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">train_using_historical_forecasts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">backtest_hist_fct</span> <span class="o">=</span> <span class="n">ensemble_hist_fct</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (no hist_fct) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (hist_fct) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest_hist_fct</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (no hist_fct) MAPE: 5.7016
RegressionEnsemble (hist_fct) MAPE: 5.12017
</pre></div></div>
</div>
<p>As expected, using historical forecasts with the forecasting models to the train the regression model produces better forecasts.</p>
</section>
<section id="Probabilistic-regression-ensemble">
<h3>Probabilistic regression ensemble<a class="headerlink" href="#Probabilistic-regression-ensemble" title="Permalink to this heading">¶</a></h3>
<p>In order to be probabilistic, the <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code>, must have a probabilistic ensembling regression model (see table in the README):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">regression_model</span><span class="o">=</span><span class="n">LinearRegressionModel</span><span class="p">(</span>
        <span class="n">lags_future_covariates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">likelihood</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span>
<span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (probabilistic) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (probabilistic) MAPE: 5.15071
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_25_1.png" src="../_images/examples_19-EnsembleModel-examples_25_1.png" />
</div>
</div>
</section>
<section id="Bootstrapping-regression-ensemble">
<h3>Bootstrapping regression ensemble<a class="headerlink" href="#Bootstrapping-regression-ensemble" title="Permalink to this heading">¶</a></h3>
<p>When the forecasting models of a <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> are probabilistic, the samples dimension of their forecasts is reduced and used as covariates for the ensembling regression. Since the ensembling regression model is deterministic, the generated forecasts is deterministic as well.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span>
            <span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">likelihood</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">ExponentialSmoothing</span><span class="p">(),</span>
    <span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">regression_train_num_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">regression_train_samples_reduction</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (bootstrap) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (bootstrap) MAPE: 5.10138
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_27_1.png" src="../_images/examples_19-EnsembleModel-examples_27_1.png" />
</div>
</div>
</section>
<section id="Pre-trained-Ensembling">
<h3>Pre-trained Ensembling<a class="headerlink" href="#Pre-trained-Ensembling" title="Permalink to this heading">¶</a></h3>
<p>As both <code class="docutils literal notranslate"><span class="pre">NaiveEnsembleModel</span></code> and <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> accept <code class="docutils literal notranslate"><span class="pre">GlobalForecastingModel</span></code> as forecasting models, they can be used to ensemble pre-trained deep learning and regression models. Note that this functionnality is only supported if all the ensembled forecasting models are instances from the <code class="docutils literal notranslate"><span class="pre">GlobalForecastingModel</span></code> class and are already trained when creating the ensemble.</p>
<p><strong>Disclaimer</strong> : Be careful not to pre-train the models with data used during validation as this would introduce considerable bias.</p>
<p><strong>Note</strong> : The parameters for the <code class="docutils literal notranslate"><span class="pre">TCNModel</span></code> is heavily inspired from the <a class="reference external" href="https://unit8co.github.io/darts/examples/05-TCN-examples.html">TCNModel example notebook</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># holding out values for validation</span>
<span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ts_air</span><span class="o">.</span><span class="n">split_after</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># scaling the target</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">val</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="c1"># use the month as a covariate</span>
<span class="n">month_series</span> <span class="o">=</span> <span class="n">dt_attr</span><span class="p">(</span><span class="n">ts_air</span><span class="o">.</span><span class="n">time_index</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">one_hot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">scaler_month</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">month_series</span> <span class="o">=</span> <span class="n">scaler_month</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">month_series</span><span class="p">)</span>

<span class="c1"># training a regular linear regression, without any covariates</span>
<span class="n">linreg_model</span> <span class="o">=</span> <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">linreg_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="c1"># instanciating a TCN model with parameters optimized for the AirPassenger dataset</span>
<span class="n">tcn_model</span> <span class="o">=</span> <span class="n">TCNModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">dilation_base</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">weight_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">num_filters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tcn_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">past_covariates</span><span class="o">=</span><span class="n">month_series</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d82f5c867b554138942e6195b2cc9d78", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TCNModel(kernel_size=5, num_filters=3, num_layers=None, dilation_base=2, weight_norm=True, dropout=0.2, input_chunk_length=24, output_chunk_length=12, n_epochs=500, random_state=0)
</pre></div></div>
</div>
<p>As a sanity check, we will look at the forecast of the model taken individually:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># individual model forecasts</span>
<span class="n">pred_linreg</span> <span class="o">=</span> <span class="n">linreg_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">pred_tcn</span> <span class="o">=</span> <span class="n">tcn_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># scaling them back</span>
<span class="n">pred_linreg_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_linreg</span><span class="p">)</span>
<span class="n">pred_tcn_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_tcn</span><span class="p">)</span>

<span class="c1"># plotting</span>
<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">pred_linreg_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;LinearRegressionModel&quot;</span><span class="p">)</span>
<span class="n">pred_tcn_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;TCNModel&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_31_0.png" src="../_images/examples_19-EnsembleModel-examples_31_0.png" />
</div>
</div>
<p>Now that we have a good idea of the individual performance of each of these models, we can ensemble them. We must make sure to set <code class="docutils literal notranslate"><span class="pre">train_forecasting_models=False</span></code> or the ensemble will need to be fitted before being able to call <code class="docutils literal notranslate"><span class="pre">predict()</span></code>.</p>
<p><strong>Advice</strong> : Use the <code class="docutils literal notranslate"><span class="pre">save()</span></code> method to export your model and keep a copy of your weights.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">naive_ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">tcn_model</span><span class="p">,</span> <span class="n">linreg_model</span><span class="p">],</span> <span class="n">train_forecasting_models</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="c1"># NaiveEnsemble initialized with pre-trained models can call predict() directly,</span>
<span class="c1"># the `series` argument must however be provided</span>
<span class="n">pred_naive</span> <span class="o">=</span> <span class="n">naive_ensemble</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">train</span><span class="p">)</span>

<span class="n">pretrain_ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">tcn_model</span><span class="p">,</span> <span class="n">linreg_model</span><span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">train_forecasting_models</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">train_using_historical_forecasts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># RegressionEnsemble must train the ensemble model, even if the forecasting models are already trained</span>
<span class="n">pretrain_ensemble</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">pred_ens</span> <span class="o">=</span> <span class="n">pretrain_ensemble</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

<span class="c1"># scaling back the predictions</span>
<span class="n">pred_naive_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_naive</span><span class="p">)</span>
<span class="n">pred_ens_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_ens</span><span class="p">)</span>

<span class="c1"># plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">pred_naive_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;pre-trained NaiveEnsemble&quot;</span><span class="p">)</span>
<span class="n">pred_ens_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;pre-trained RegressionEnsemble&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>

<span class="c1"># MAPE</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LinearRegression MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_linreg_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TCNModel MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_tcn_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (pre-trained) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_naive_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;RegressionEnsemble (pre-trained) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_ens_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LinearRegression MAPE: 3.91311
TCNModel MAPE: 4.70491
NaiveEnsemble (pre-trained) MAPE: 3.82837
RegressionEnsemble (pre-trained) MAPE: 3.61749
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_33_1.png" src="../_images/examples_19-EnsembleModel-examples_33_1.png" />
</div>
</div>
</section>
</section>
<section id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Permalink to this heading">¶</a></h2>
<p>Ensembling pre-trained <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> and <code class="docutils literal notranslate"><span class="pre">TCNModel</span></code> models allowed us to out-perform single models and training a linear regression on top of these two models forecasts further improved the MAPE score.</p>
<p>If the gains remain limited on this small dataset, ensembling is a powerful technique that can yield impressive results and was notably used by the winners of the 4th edition of the Makridakis Competition (<a class="reference external" href="https://mofc.unic.ac.cy/history-of-competitions/">website</a>, <a class="reference external" href="https://github.com/Mcompetitions/">github repository</a>).</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="21-TSMixer-examples.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Time Series Mixer (TSMixer)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="10-Kalman-filter-examples.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Filtering and predicting using the darts filters</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020 - 2025, Unit8 SA (Apache 2.0 License).<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.0.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>