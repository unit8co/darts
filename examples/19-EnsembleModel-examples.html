
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Ensembling Models &#8212; darts  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d50e28e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=7aa11fa7"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/19-EnsembleModel-examples';</script>
    <link rel="icon" href="../_static/docs-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Filtering and predicting using the darts filters" href="10-Kalman-filter-examples.html" />
    <link rel="prev" title="Chronos-2 Foundation Model" href="25-Chronos-2-examples.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.39.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/darts-logo-light.png" class="logo__image only-light" alt="darts  documentation - Home"/>
    <img src="../_static/darts-logo-dark.png" class="logo__image only-dark pst-js-only" alt="darts  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../quickstart/00-quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../generated_api/darts.html">
    API Reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release_notes/RELEASE_NOTES.html">
    Release Notes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/unit8co/darts" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/unit8co" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../quickstart/00-quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../generated_api/darts.html">
    API Reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release_notes/RELEASE_NOTES.html">
    Release Notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/unit8co/darts" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/unit8co" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01-multi-time-series-and-covariates.html">Multiple Time Series, Pre-trained Models and Covariates</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="02-data-processing.html">Data (pre) processing using <code class="docutils literal notranslate"><span class="pre">DataTransformer</span></code> and <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="15-static-covariates.html">Static Covariates</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="14-transfer-learning.html">Transfer Learning for Time Series Forecasting with Darts</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="16-hierarchical-reconciliation.html">Hierarchical Reconciliation - Example on the Australian Tourism Dataset</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="17-hyperparameter-optimization.html">Hyper-parameters Optimization for Electricity Load Forecasting</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="20-SKLearnModel-examples.html">Regression Models</a></li>

</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="24-SKLearnClassifierModel-examples.html">Classification Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="23-Conformal-Prediction-examples.html">Conformal Prediction Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="03-FFT-examples.html">Fast Fourier Transform Forecasting Model (FFT)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="04-RNN-examples.html">Recurrent Neural Networks Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="05-TCN-examples.html">Temporal Convolutional Network</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="06-Transformer-examples.html">Transformer Model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="07-NBEATS-examples.html">N-BEATS</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="08-DeepAR-examples.html">Probabilistic RNN</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="09-DeepTCN-examples.html">DeepTCN model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="13-TFT-examples.html">Temporal Fusion Transformer</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="18-TiDE-examples.html">TimeSeries Deep Encoder</a></li>




</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="21-TSMixer-examples.html">Time Series Mixer (TSMixer)</a></li>






</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="25-Chronos-2-examples.html">Chronos-2 Foundation Model</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Ensembling Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="10-Kalman-filter-examples.html">Filtering and predicting using the darts filters</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="11-GP-filter-examples.html">Filtering and predicting using the Gaussian Process filter</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="22-anomaly-detection-examples.html">Anomaly Detection Darts Module</a></li>




</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="12-Dynamic-Time-Warping-example.html">Dynamic Time Warping (DTW)</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../examples.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Ensembling Models</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Ensembling-Models">
<h1>Ensembling Models<a class="headerlink" href="#Ensembling-Models" title="Link to this heading">#</a></h1>
<p>The following is a brief demonstration of the ensemble models in Darts. Starting from the examples provided in the <a class="reference external" href="https://unit8co.github.io/darts/quickstart/00-quickstart.html">Quickstart Notebook</a>, some advanced features and subtilities will be detailed.</p>
<p>The following topics are covered in this notebook :</p>
<ul class="simple">
<li><p><a class="reference internal" href="#Basics-&amp;-references"><span class="std std-ref">Basics &amp; references</span></a></p></li>
<li><p><a class="reference internal" href="#Naive-Ensembling"><span class="std std-ref">Naive Ensembling</span></a></p>
<ul>
<li><p><a class="reference internal" href="#Naive-Ensembling"><span class="std std-ref">Deterministic</span></a></p></li>
<li><p><a class="reference internal" href="#Using-covariates-&amp;-predicting-multivariate-series"><span class="std std-ref">Covariates &amp; multivariate series</span></a></p></li>
<li><p><a class="reference internal" href="#Probabilistic-naive-ensembling"><span class="std std-ref">Probabilistic</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#Learned-Ensembling"><span class="std std-ref">Learned Ensembling</span></a></p>
<ul>
<li><p><a class="reference internal" href="#Learned-Ensembling"><span class="std std-ref">Deterministic</span></a></p></li>
<li><p><a class="reference internal" href="#Probabilistic-regression-ensemble"><span class="std std-ref">Probabilistic</span></a></p></li>
<li><p><a class="reference internal" href="#Bootstrapping-regression-ensemble"><span class="std std-ref">Bootstrapping</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#Pre-trained-Ensembling"><span class="std std-ref">Pre-trained Ensembling</span></a></p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fix python path if working locally</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">fix_pythonpath_if_working_locally</span>

<span class="n">fix_pythonpath_if_working_locally</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># use darts plotting style</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_option</span>

<span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;plotting.use_darts_style&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">darts.dataprocessing.transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AirPassengersDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExponentialSmoothing</span><span class="p">,</span>
    <span class="n">KalmanForecaster</span><span class="p">,</span>
    <span class="n">LinearRegressionModel</span><span class="p">,</span>
    <span class="n">NaiveDrift</span><span class="p">,</span>
    <span class="n">NaiveEnsembleModel</span><span class="p">,</span>
    <span class="n">NaiveSeasonal</span><span class="p">,</span>
    <span class="n">RandomForestModel</span><span class="p">,</span>
    <span class="n">RegressionEnsembleModel</span><span class="p">,</span>
    <span class="n">TCNModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.timeseries_generation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime_attribute_timeseries</span> <span class="k">as</span> <span class="n">dt_attr</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Basics-&amp;-references">
<h2>Basics &amp; references<a class="headerlink" href="#Basics-&-references" title="Link to this heading">#</a></h2>
<p>Ensembling combines the forecasts of several “weak” models to obtain a more robust and accurate model.</p>
<p>All of Darts’ ensembling models rely on the <strong>stacking technique</strong> (<a class="reference external" href="https://machinelearningmastery.com/essence-of-stacking-ensembles-for-machine-learning/">reference</a>). They provide the same functionalities as the other forecasting models. Depending on the ensembled models, they can:</p>
<ul class="simple">
<li><p>levarage covariates</p></li>
<li><p>be trained on multiple-series</p></li>
<li><p>predict multivariate targets</p></li>
<li><p>generate probabilistic forecasts</p></li>
<li><p>and more…</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># using the AirPassenger dataset, directly available in darts</span>
<span class="n">ts_air</span> <span class="o">=</span> <span class="n">AirPassengersDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: xlabel=&#39;Month&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_4_1.png" src="../_images/examples_19-EnsembleModel-examples_4_1.png" />
</div>
</div>
</section>
<section id="Naive-Ensembling">
<h2>Naive Ensembling<a class="headerlink" href="#Naive-Ensembling" title="Link to this heading">#</a></h2>
<p>Naive ensembling simply takes the average (mean) of the forecasts generated by the ensembled forecasting models. Darts’ <code class="docutils literal notranslate"><span class="pre">NaiveEnsembleModel</span></code> accepts both local and global forecasting models (as well as combination of the two, with some additional limitations).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">naive_ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">NaiveSeasonal</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">NaiveDrift</span><span class="p">()]</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">naive_ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (naive) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NaiveEnsemble (naive) MAPE: 11.87818
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_6_1.png" src="../_images/examples_19-EnsembleModel-examples_6_1.png" />
</div>
</div>
<p><strong>Note</strong>: after looking at the each model’s MAPE, one would notice that <code class="docutils literal notranslate"><span class="pre">NaiveSeasonal</span></code> is actually performing better on its own than ensembled with <code class="docutils literal notranslate"><span class="pre">NaiveDrift</span></code>. Checking the performance of the single models is in general a good practice before defining an ensemble.</p>
<p>Before creating the new <code class="docutils literal notranslate"><span class="pre">NaiveEnsemble</span></code>, we will screen models to identify which ones would do well together. The candidates are :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> : classic and simple model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code> : moving window model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">KalmanForecaster</span></code> : a filter-based model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandomForestModel</span></code> : decision trees model</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">candidates_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;LinearRegression&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">LinearRegressionModel</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;lags&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}),</span>
    <span class="s2">&quot;ExponentialSmoothing&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">ExponentialSmoothing</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="s2">&quot;KalmanForecaster&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">KalmanForecaster</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dim_x&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}),</span>
    <span class="s2">&quot;RandomForestModel&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">RandomForestModel</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;lags&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;random_state&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}),</span>
<span class="p">}</span>

<span class="n">backtest_models</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="p">(</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidates_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
    <span class="n">backtest_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> MAPE: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">ts_air</span><span class="p">),</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LinearRegression MAPE: 4.64008
ExponentialSmoothing MAPE: 4.44774
KalmanForecaster MAPE: 4.5539
RandomForestModel MAPE: 8.02264
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fix</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">backtest</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">backtest_models</span><span class="p">,</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">candidates_models</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<span class="p">):</span>
    <span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_9_0.png" src="../_images/examples_19-EnsembleModel-examples_9_0.png" />
</div>
</div>
<p>The historical forecasts obtained with the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> and <code class="docutils literal notranslate"><span class="pre">KalmanForecaster</span></code> look quite similar whereas <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code> tends to understimate the true values and <code class="docutils literal notranslate"><span class="pre">RandomForestModel</span></code> is failing to capture the peaks. To benefits from the ensemble, we will favor diversity and continue with the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> and <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code>.£</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()]</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (v2) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NaiveEnsemble (v2) MAPE: 4.04297
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_11_1.png" src="../_images/examples_19-EnsembleModel-examples_11_1.png" />
</div>
</div>
<p>Compared to the individual model MAPE score, 4.64008 for the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> and 4.44874 for the <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code>, the ensembling improved the accuracy to 4.04297!</p>
<section id="Using-covariates-&amp;-predicting-multivariate-series">
<h3>Using covariates &amp; predicting multivariate series<a class="headerlink" href="#Using-covariates-&-predicting-multivariate-series" title="Link to this heading">#</a></h3>
<p>Depending on the forecasting models used, the <code class="docutils literal notranslate"><span class="pre">EnsembleModel</span></code> can of course also leverage covariates or forecast multivariates series! The covariates will be passed only to the forecasting models supporting them.</p>
<p>In the example below, the <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code> model does not support any covariates whereas the <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> model supports <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">([</span>
    <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lags_future_covariates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="n">ExponentialSmoothing</span><span class="p">(),</span>
<span class="p">])</span>

<span class="c1"># encoding the months as integer, normalised</span>
<span class="n">future_cov</span> <span class="o">=</span> <span class="n">dt_attr</span><span class="p">(</span><span class="n">ts_air</span><span class="o">.</span><span class="n">time_index</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">add_length</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">future_covariates</span><span class="o">=</span><span class="n">future_cov</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (w/ future covariates) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NaiveEnsemble (w/ future covariates) MAPE: 4.07502
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_13_1.png" src="../_images/examples_19-EnsembleModel-examples_13_1.png" />
</div>
</div>
</section>
<section id="Probabilistic-naive-ensembling">
<h3>Probabilistic naive ensembling<a class="headerlink" href="#Probabilistic-naive-ensembling" title="Link to this heading">#</a></h3>
<p>Combining models supporting probabilistic forecasts results in a probabilistic <code class="docutils literal notranslate"><span class="pre">NaiveEnsembleModel</span></code>! We can easily tweak the models used above to make them probabilistic and obtain confidence interval in ours forecasts:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble_probabilistic</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span>
            <span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">likelihood</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">ExponentialSmoothing</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># must pass num_samples &gt; 1 to obtain a probabilistic forecasts</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble_probabilistic</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span>
<span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: xlabel=&#39;time&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_15_1.png" src="../_images/examples_19-EnsembleModel-examples_15_1.png" />
</div>
</div>
</section>
</section>
<section id="Learned-Ensembling">
<h2>Learned Ensembling<a class="headerlink" href="#Learned-Ensembling" title="Link to this heading">#</a></h2>
<p>Ensembling can also be considered as a supervised regression problem: given a set of forecasts (features), find a model that combines them in order to minimise errors on the target. This is what the <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> does. The main three parameters are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">forecasting_models</span></code> is a list of forecasting models whose predictions we want to ensemble.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_train_n_points</span></code> is the number of time steps to use for fitting the “ensemble regression” model (i.e., the inner model that combines the forecasts).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model</span></code> is, optionally, a sklearn-compatible regression model or a Darts <code class="docutils literal notranslate"><span class="pre">SKLearnModel</span></code> to be used for the ensemble regression. If not specified, Darts’ <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> is used. Using a sklearn model is easy out-of-the-box, but using one of Darts’ regression models allows to potentially take arbitrary lags of the individual forecasts as inputs of the regression model.</p></li>
</ul>
<p>Once these elements are in place, a <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> can be used like a regular forecasting model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble_model</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">NaiveSeasonal</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">NaiveDrift</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble_model</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (naive) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (naive) MAPE: 4.85142
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_17_1.png" src="../_images/examples_19-EnsembleModel-examples_17_1.png" />
</div>
</div>
<p>Compared to the MAPE of 11.87818 obtained at the beginning of the <a class="reference internal" href="#Naive-Ensembling"><span class="std std-ref">naive ensembling section</span></a>, adding a <code class="docutils literal notranslate"><span class="pre">LinearRegressionModel</span></code> on top of the two naive models does improve the quality of the forecast.</p>
<p>Now, let’s see if we can observe similar gain when the <code class="docutils literal notranslate"><span class="pre">RegressionEnsemble</span></code> forecasting models are not naive:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (v2) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (v2) MAPE: 4.63334
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_19_1.png" src="../_images/examples_19-EnsembleModel-examples_19_1.png" />
</div>
</div>
<p>Interestingly, even if the MAPE improved compared to the <code class="docutils literal notranslate"><span class="pre">RegressionEnsemble</span></code> relying on naive models (MAPE: 4.85142), it does not outperform the <code class="docutils literal notranslate"><span class="pre">NaiveEnsemble</span></code> using similar forecasting models (MAPE: 4.04297).</p>
<p>This performance gap is partially caused by the points set aside to train the ensembling <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code>; the two forecasting models (<code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> and <code class="docutils literal notranslate"><span class="pre">ExponentialSmoothing</span></code>) cannot access the latest values of the series, which contains a marked upward trend.</p>
<p>Out of curiosity, we can use the <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> regression model from the sklearn library to ensemble the forecasts:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ridge</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">regression_model</span><span class="o">=</span><span class="n">Ridge</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (Ridge) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (Ridge) MAPE: 6.46803
</pre></div></div>
</div>
<p>In this particuliar scenario, using a regression model with a regularization term deteriorated the forecasts but there might be other cases where it will improve them.</p>
<section id="Training-using-historical-forecasts">
<h3>Training using historical forecasts<a class="headerlink" href="#Training-using-historical-forecasts" title="Link to this heading">#</a></h3>
<p>When predicting a number of values greater than their <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>, <code class="docutils literal notranslate"><span class="pre">GlobalForecastingModels</span></code> rely on auto-regression (use their own output as input) to forecast values far in the future. However, the quality of the forecasts can considerably decrease as the predicted timestamp get further from the end of the observations. During <code class="docutils literal notranslate"><span class="pre">RegressionEnsemble</span></code>’s regression model training, the forecasting models generate forecasts for timestamps where the ground truth is actually known and
available, making it possible to use <code class="docutils literal notranslate"><span class="pre">historical_forecasts</span></code> instead of <code class="docutils literal notranslate"><span class="pre">predict()</span></code>.</p>
<p>This can be activated with <code class="docutils literal notranslate"><span class="pre">train_using_historical_forecasts=True</span></code>.</p>
<p>Under the hood, the ensemble model will trigger historical forecasting for each model with <code class="docutils literal notranslate"><span class="pre">forecast_horizon=model.output_chunk_length</span></code>, <code class="docutils literal notranslate"><span class="pre">stride=model.output_chunk_length</span></code>, <code class="docutils literal notranslate"><span class="pre">last_points_only=False</span></code>, and <code class="docutils literal notranslate"><span class="pre">overlap_end=False</span></code> to predict the last <code class="docutils literal notranslate"><span class="pre">regression_train_n_points</span></code> points of the target series.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># replacing the ExponentialSmoothing (local) with RandomForestModel (global)</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">RandomForestModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">train_using_historical_forecasts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ensemble_hist_fct</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">RandomForestModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">train_using_historical_forecasts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">backtest_hist_fct</span> <span class="o">=</span> <span class="n">ensemble_hist_fct</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (no hist_fct) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (hist_fct) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest_hist_fct</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (no hist_fct) MAPE: 5.7016
RegressionEnsemble (hist_fct) MAPE: 5.12017
</pre></div></div>
</div>
<p>As expected, using historical forecasts with the forecasting models to the train the regression model produces better forecasts.</p>
</section>
<section id="Probabilistic-regression-ensemble">
<h3>Probabilistic regression ensemble<a class="headerlink" href="#Probabilistic-regression-ensemble" title="Link to this heading">#</a></h3>
<p>In order to be probabilistic, the <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code>, must have a probabilistic ensembling regression model (see table in the README):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="n">ExponentialSmoothing</span><span class="p">()],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">regression_model</span><span class="o">=</span><span class="n">LinearRegressionModel</span><span class="p">(</span>
        <span class="n">lags_future_covariates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">likelihood</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span>
<span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (probabilistic) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (probabilistic) MAPE: 5.15071
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_25_1.png" src="../_images/examples_19-EnsembleModel-examples_25_1.png" />
</div>
</div>
</section>
<section id="Bootstrapping-regression-ensemble">
<h3>Bootstrapping regression ensemble<a class="headerlink" href="#Bootstrapping-regression-ensemble" title="Link to this heading">#</a></h3>
<p>When the forecasting models of a <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> are probabilistic, the samples dimension of their forecasts is reduced and used as covariates for the ensembling regression. Since the ensembling regression model is deterministic, the generated forecasts is deterministic as well.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LinearRegressionModel</span><span class="p">(</span>
            <span class="n">lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">likelihood</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">ExponentialSmoothing</span><span class="p">(),</span>
    <span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">regression_train_num_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">regression_train_samples_reduction</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span><span class="n">ts_air</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">backtest</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegressionEnsemble (bootstrap) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RegressionEnsemble (bootstrap) MAPE: 5.10138
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_27_1.png" src="../_images/examples_19-EnsembleModel-examples_27_1.png" />
</div>
</div>
</section>
<section id="Pre-trained-Ensembling">
<h3>Pre-trained Ensembling<a class="headerlink" href="#Pre-trained-Ensembling" title="Link to this heading">#</a></h3>
<p>As both <code class="docutils literal notranslate"><span class="pre">NaiveEnsembleModel</span></code> and <code class="docutils literal notranslate"><span class="pre">RegressionEnsembleModel</span></code> accept <code class="docutils literal notranslate"><span class="pre">GlobalForecastingModel</span></code> as forecasting models, they can be used to ensemble pre-trained deep learning and regression models. Note that this functionnality is only supported if all the ensembled forecasting models are instances from the <code class="docutils literal notranslate"><span class="pre">GlobalForecastingModel</span></code> class and are already trained when creating the ensemble.</p>
<p><strong>Disclaimer</strong> : Be careful not to pre-train the models with data used during validation as this would introduce considerable bias.</p>
<p><strong>Note</strong> : The parameters for the <code class="docutils literal notranslate"><span class="pre">TCNModel</span></code> is heavily inspired from the <a class="reference external" href="https://unit8co.github.io/darts/examples/05-TCN-examples.html">TCNModel example notebook</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># holding out values for validation</span>
<span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ts_air</span><span class="o">.</span><span class="n">split_after</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># scaling the target</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">val</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="c1"># use the month as a covariate</span>
<span class="n">month_series</span> <span class="o">=</span> <span class="n">dt_attr</span><span class="p">(</span><span class="n">ts_air</span><span class="o">.</span><span class="n">time_index</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">one_hot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">scaler_month</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">month_series</span> <span class="o">=</span> <span class="n">scaler_month</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">month_series</span><span class="p">)</span>

<span class="c1"># training a regular linear regression, without any covariates</span>
<span class="n">linreg_model</span> <span class="o">=</span> <span class="n">LinearRegressionModel</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">linreg_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="c1"># instanciating a TCN model with parameters optimized for the AirPassenger dataset</span>
<span class="n">tcn_model</span> <span class="o">=</span> <span class="n">TCNModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">dilation_base</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">weight_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">num_filters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tcn_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">past_covariates</span><span class="o">=</span><span class="n">month_series</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d82f5c867b554138942e6195b2cc9d78", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TCNModel(kernel_size=5, num_filters=3, num_layers=None, dilation_base=2, weight_norm=True, dropout=0.2, input_chunk_length=24, output_chunk_length=12, n_epochs=500, random_state=0)
</pre></div></div>
</div>
<p>As a sanity check, we will look at the forecast of the model taken individually:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># individual model forecasts</span>
<span class="n">pred_linreg</span> <span class="o">=</span> <span class="n">linreg_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">pred_tcn</span> <span class="o">=</span> <span class="n">tcn_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># scaling them back</span>
<span class="n">pred_linreg_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_linreg</span><span class="p">)</span>
<span class="n">pred_tcn_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_tcn</span><span class="p">)</span>

<span class="c1"># plotting</span>
<span class="n">ts_air</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">pred_linreg_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;LinearRegressionModel&quot;</span><span class="p">)</span>
<span class="n">pred_tcn_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;TCNModel&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_31_0.png" src="../_images/examples_19-EnsembleModel-examples_31_0.png" />
</div>
</div>
<p>Now that we have a good idea of the individual performance of each of these models, we can ensemble them. We must make sure to set <code class="docutils literal notranslate"><span class="pre">train_forecasting_models=False</span></code> or the ensemble will need to be fitted before being able to call <code class="docutils literal notranslate"><span class="pre">predict()</span></code>.</p>
<p><strong>Advice</strong> : Use the <code class="docutils literal notranslate"><span class="pre">save()</span></code> method to export your model and keep a copy of your weights.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">naive_ensemble</span> <span class="o">=</span> <span class="n">NaiveEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">tcn_model</span><span class="p">,</span> <span class="n">linreg_model</span><span class="p">],</span> <span class="n">train_forecasting_models</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="c1"># NaiveEnsemble initialized with pre-trained models can call predict() directly,</span>
<span class="c1"># the `series` argument must however be provided</span>
<span class="n">pred_naive</span> <span class="o">=</span> <span class="n">naive_ensemble</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">train</span><span class="p">)</span>

<span class="n">pretrain_ensemble</span> <span class="o">=</span> <span class="n">RegressionEnsembleModel</span><span class="p">(</span>
    <span class="n">forecasting_models</span><span class="o">=</span><span class="p">[</span><span class="n">tcn_model</span><span class="p">,</span> <span class="n">linreg_model</span><span class="p">],</span>
    <span class="n">regression_train_n_points</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">train_forecasting_models</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">train_using_historical_forecasts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># RegressionEnsemble must train the ensemble model, even if the forecasting models are already trained</span>
<span class="n">pretrain_ensemble</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">pred_ens</span> <span class="o">=</span> <span class="n">pretrain_ensemble</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

<span class="c1"># scaling back the predictions</span>
<span class="n">pred_naive_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_naive</span><span class="p">)</span>
<span class="n">pred_ens_rescaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_ens</span><span class="p">)</span>

<span class="c1"># plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ground truth&quot;</span><span class="p">)</span>
<span class="n">pred_naive_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;pre-trained NaiveEnsemble&quot;</span><span class="p">)</span>
<span class="n">pred_ens_rescaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;pre-trained RegressionEnsemble&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">250</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>

<span class="c1"># MAPE</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LinearRegression MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_linreg_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TCNModel MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_tcn_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaiveEnsemble (pre-trained) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_naive_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;RegressionEnsemble (pre-trained) MAPE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mape</span><span class="p">(</span><span class="n">pred_ens_rescaled</span><span class="p">,</span> <span class="n">ts_air</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LinearRegression MAPE: 3.91311
TCNModel MAPE: 4.70491
NaiveEnsemble (pre-trained) MAPE: 3.82837
RegressionEnsemble (pre-trained) MAPE: 3.61749
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_19-EnsembleModel-examples_33_1.png" src="../_images/examples_19-EnsembleModel-examples_33_1.png" />
</div>
</div>
</section>
</section>
<section id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Link to this heading">#</a></h2>
<p>Ensembling pre-trained <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> and <code class="docutils literal notranslate"><span class="pre">TCNModel</span></code> models allowed us to out-perform single models and training a linear regression on top of these two models forecasts further improved the MAPE score.</p>
<p>If the gains remain limited on this small dataset, ensembling is a powerful technique that can yield impressive results and was notably used by the winners of the 4th edition of the Makridakis Competition (<a class="reference external" href="https://mofc.unic.ac.cy/history-of-competitions/">website</a>, <a class="reference external" href="https://github.com/Mcompetitions/">github repository</a>).</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="25-Chronos-2-examples.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Chronos-2 Foundation Model</p>
      </div>
    </a>
    <a class="right-next"
       href="10-Kalman-filter-examples.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Filtering and predicting using the darts filters</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Basics-&amp;-references">Basics &amp; references</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Naive-Ensembling">Naive Ensembling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Using-covariates-&amp;-predicting-multivariate-series">Using covariates &amp; predicting multivariate series</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Probabilistic-naive-ensembling">Probabilistic naive ensembling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Learned-Ensembling">Learned Ensembling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-using-historical-forecasts">Training using historical forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Probabilistic-regression-ensemble">Probabilistic regression ensemble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Bootstrapping-regression-ensemble">Bootstrapping regression ensemble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Pre-trained-Ensembling">Pre-trained Ensembling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Conclusion">Conclusion</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples/19-EnsembleModel-examples.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2020 - 2025, Unit8 SA (Apache 2.0 License).
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>