
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Temporal Fusion Transformer &#8212; darts  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d50e28e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=7aa11fa7"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/13-TFT-examples';</script>
    <link rel="icon" href="../_static/docs-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="TimeSeries Deep Encoder" href="18-TiDE-examples.html" />
    <link rel="prev" title="DeepTCN model" href="09-DeepTCN-examples.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.40.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/darts-logo-light.png" class="logo__image only-light" alt="darts  documentation - Home"/>
    <img src="../_static/darts-logo-dark.png" class="logo__image only-dark pst-js-only" alt="darts  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../quickstart/00-quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../generated_api/darts.html">
    API Reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release_notes/RELEASE_NOTES.html">
    Release Notes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/unit8co/darts" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/unit8co" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../quickstart/00-quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../generated_api/darts.html">
    API Reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release_notes/RELEASE_NOTES.html">
    Release Notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/unit8co/darts" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/unit8co" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01-multi-time-series-and-covariates.html">Multiple Time Series, Pre-trained Models and Covariates</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="02-data-processing.html">Data (pre) processing using <code class="docutils literal notranslate"><span class="pre">DataTransformer</span></code> and <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="15-static-covariates.html">Static Covariates</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="14-transfer-learning.html">Transfer Learning for Time Series Forecasting with Darts</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="16-hierarchical-reconciliation.html">Hierarchical Reconciliation - Example on the Australian Tourism Dataset</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="17-hyperparameter-optimization.html">Hyper-parameters Optimization for Electricity Load Forecasting</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="20-SKLearnModel-examples.html">Regression Models</a></li>

</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="24-SKLearnClassifierModel-examples.html">Classification Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="23-Conformal-Prediction-examples.html">Conformal Prediction Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="03-FFT-examples.html">Fast Fourier Transform Forecasting Model (FFT)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="04-RNN-examples.html">Recurrent Neural Networks Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="05-TCN-examples.html">Temporal Convolutional Network</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="06-Transformer-examples.html">Transformer Model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="07-NBEATS-examples.html">N-BEATS</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="08-DeepAR-examples.html">Probabilistic RNN</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="09-DeepTCN-examples.html">DeepTCN model</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Temporal Fusion Transformer</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="18-TiDE-examples.html">TimeSeries Deep Encoder</a></li>




</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="21-TSMixer-examples.html">Time Series Mixer (TSMixer)</a></li>






</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="25-Chronos-2-examples.html">Chronos-2 Foundation Model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="19-EnsembleModel-examples.html">Ensembling Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="10-Kalman-filter-examples.html">Filtering and predicting using the darts filters</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="11-GP-filter-examples.html">Filtering and predicting using the Gaussian Process filter</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="22-anomaly-detection-examples.html">Anomaly Detection Darts Module</a></li>




</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="12-Dynamic-Time-Warping-example.html">Dynamic Time Warping (DTW)</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../examples.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Temporal Fusion Transformer</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Temporal-Fusion-Transformer">
<h1>Temporal Fusion Transformer<a class="headerlink" href="#Temporal-Fusion-Transformer" title="Link to this heading">#</a></h1>
<p>In this notebook, we show two examples of how two use Darts’ <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code>. If you are new to darts, we recommend you first follow the <a class="reference external" href="https://unit8co.github.io/darts/quickstart/00-quickstart.html">quick start</a> notebook.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fix python path if working locally</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">fix_pythonpath_if_working_locally</span>

<span class="n">fix_pythonpath_if_working_locally</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use darts plotting style</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_option</span>

<span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;plotting.use_darts_style&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">darts</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeries</span><span class="p">,</span> <span class="n">concatenate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.dataprocessing.transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AirPassengersDataset</span><span class="p">,</span> <span class="n">IceCreamHeaterDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">TFTModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.likelihood_models.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantileRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.statistics</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_seasonality</span><span class="p">,</span> <span class="n">plot_acf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.timeseries_generation</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime_attribute_timeseries</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Temporal-Fusion-Transformer-(TFT)">
<h2>Temporal Fusion Transformer (TFT)<a class="headerlink" href="#Temporal-Fusion-Transformer-(TFT)" title="Link to this heading">#</a></h2>
<p>Darts’ <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> incorporates the following main components from the original Temporal Fusion Transformer (TFT) architecture as outlined in <a class="reference external" href="https://arxiv.org/pdf/1912.09363.pdf">this paper</a>:</p>
<ul class="simple">
<li><p>gating mechanisms: skip over unused components of the model architecture</p></li>
<li><p>variable selection networks: select relevant input variables at each time step.</p></li>
<li><p>temporal processing of past and future input with LSTMs (long short-term memory)</p></li>
<li><p>multi-head attention: captures long-term temporal dependencies</p></li>
<li><p>prediction intervals: per default, produces quantile forecasts instead of deterministic values</p></li>
</ul>
<section id="Training">
<h3>Training<a class="headerlink" href="#Training" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> can be trained with past and future covariates. It is trained sequentially on fixed-size chunks consisting of an encoder and a decoder part:</p>
<ul class="simple">
<li><p>encoder: past input with <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code></p>
<ul>
<li><p><strong>past target</strong>: mandatory</p></li>
<li><p><strong>past covariates</strong>: optional</p></li>
</ul>
</li>
<li><p>decoder: future known input with <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code></p>
<ul>
<li><p><strong>future covariates</strong>: mandatory (if none are available, consider <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code>’s optional arguments <code class="docutils literal notranslate"><span class="pre">add_encoders</span></code> or <code class="docutils literal notranslate"><span class="pre">add_relative_index</span></code> from <a class="reference external" href="https://unit8co.github.io/darts/generated_api/darts.models.forecasting.tft_model.html?highlight=tftmodel#temporal-fusion-transformer-tft">here</a>)</p></li>
</ul>
</li>
</ul>
<p>In each iteration, the model produces a quantile prediction of shape <code class="docutils literal notranslate"><span class="pre">(output_chunk_length,</span> <span class="pre">n_quantiles)</span></code> on the decoder part.</p>
</section>
<section id="Forecast">
<h3>Forecast<a class="headerlink" href="#Forecast" title="Link to this heading">#</a></h3>
<section id="Probabilistic-Forecast">
<h4>Probabilistic Forecast<a class="headerlink" href="#Probabilistic-Forecast" title="Link to this heading">#</a></h4>
<p>Per default, <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> produces probabilistic quantile forecasts using <code class="docutils literal notranslate"><span class="pre">QuantileRegression</span></code>. This gives the range of likely target values at each prediction step. Most deep learning models in Darts’ - including <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> - support <code class="docutils literal notranslate"><span class="pre">QuantileRegression</span></code> and 16 other likelihoods to produce probabilistic forecasts by setting <code class="docutils literal notranslate"><span class="pre">likelihood=MyLikelihood()</span></code> at model creation.</p>
<p>To produce meaningful results, set <code class="docutils literal notranslate"><span class="pre">num_samples</span> <span class="pre">&gt;&gt;</span> <span class="pre">1</span></code> when predicting. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>model.predict(*args, **kwargs, num_samples=200)
</pre></div>
</div>
<p>Predictions with forecasting horizon <code class="docutils literal notranslate"><span class="pre">n</span></code> are generated auto-regressively using encoder-decoder chunks of the same size as during training.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;</span> <span class="pre">output_chunk_length</span></code>, you have to supply additional future values for the covariates you passed to <code class="docutils literal notranslate"><span class="pre">model.train()</span></code>.</p>
</section>
<section id="Deterministic-Forecast">
<h4>Deterministic Forecast<a class="headerlink" href="#Deterministic-Forecast" title="Link to this heading">#</a></h4>
<p>To produce deterministic rather than probabilistic forecasts, set parameter <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> to <code class="docutils literal notranslate"><span class="pre">None</span></code> and <code class="docutils literal notranslate"><span class="pre">loss_fn</span></code> to a PyTorch loss function at model creation. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>model = TFTModel(*args, **kwargs, likelihood=None, loss_fn=torch.nn.MSELoss())
...
model.predict(*args, **kwargs, num_samples=1)
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># before starting, we define some constants</span>
<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">lowest_q</span><span class="p">,</span> <span class="n">low_q</span><span class="p">,</span> <span class="n">high_q</span><span class="p">,</span> <span class="n">highest_q</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span>
<span class="n">label_q_outer</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">lowest_q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">highest_q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">th percentiles&quot;</span>
<span class="n">label_q_inner</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">low_q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">high_q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">th percentiles&quot;</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="Air-Passenger-Example">
<h2>Air Passenger Example<a class="headerlink" href="#Air-Passenger-Example" title="Link to this heading">#</a></h2>
<p>This data set that is highly dependent on covariates. Knowing the month tells us a lot about the seasonal component, whereas the year determines the effect of the trend component.</p>
<p>Additionally, let’s convert the time index to integer values and use them as covariates as well.</p>
<p>All of the three covariates are known in the future, and can be used as <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> with the <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read data</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">AirPassengersDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># we convert monthly number of passengers to average daily number of passengers per month</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">series</span> <span class="o">/</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_values</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">time_index</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">)</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Create training and validation sets:</span>
<span class="n">training_cutoff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;19571201&quot;</span><span class="p">)</span>
<span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">split_after</span><span class="p">(</span><span class="n">training_cutoff</span><span class="p">)</span>

<span class="c1"># Normalize the time series (note: we avoid fitting the transformer on the validation set)</span>
<span class="n">transformer</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">train_transformed</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">val_transformed</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="n">series_transformed</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

<span class="c1"># create year, month and integer index covariate series</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="n">datetime_attribute_timeseries</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">one_hot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
    <span class="n">datetime_attribute_timeseries</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">one_hot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
    <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_times_and_values</span><span class="p">(</span>
        <span class="n">times</span><span class="o">=</span><span class="n">series</span><span class="o">.</span><span class="n">time_index</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;linear_increase&quot;</span><span class="p">],</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># transform covariates (note: we fit the transformer on train split and can then transform the entire covariates series)</span>
<span class="n">scaler_covs</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">cov_train</span><span class="p">,</span> <span class="n">cov_val</span> <span class="o">=</span> <span class="n">covariates</span><span class="o">.</span><span class="n">split_after</span><span class="p">(</span><span class="n">training_cutoff</span><span class="p">)</span>
<span class="n">scaler_covs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_train</span><span class="p">)</span>
<span class="n">covariates_transformed</span> <span class="o">=</span> <span class="n">scaler_covs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Create-a-model">
<h3>Create a model<a class="headerlink" href="#Create-a-model" title="Link to this heading">#</a></h3>
<p>If you want to produce deterministic forecasts rather than quantile forecasts, you can use a PyTorch loss function (i.e., set <code class="docutils literal notranslate"><span class="pre">loss_fn=torch.nn.MSELoss()</span></code> and <code class="docutils literal notranslate"><span class="pre">likelihood=None</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> can only be used if some future input is given. Optional parameters <code class="docutils literal notranslate"><span class="pre">add_encoders</span></code> and <code class="docutils literal notranslate"><span class="pre">add_relative_index</span></code> can be useful, especially if we don’t have any future input available. They generate encoded temporal data that is used as future covariates.</p>
<p>Since we already have future covariates defined in our example they are commented out.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># default quantiles for QuantileRegression</span>
<span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.01</span><span class="p">,</span>
    <span class="mf">0.05</span><span class="p">,</span>
    <span class="mf">0.1</span><span class="p">,</span>
    <span class="mf">0.15</span><span class="p">,</span>
    <span class="mf">0.2</span><span class="p">,</span>
    <span class="mf">0.25</span><span class="p">,</span>
    <span class="mf">0.3</span><span class="p">,</span>
    <span class="mf">0.4</span><span class="p">,</span>
    <span class="mf">0.5</span><span class="p">,</span>
    <span class="mf">0.6</span><span class="p">,</span>
    <span class="mf">0.7</span><span class="p">,</span>
    <span class="mf">0.75</span><span class="p">,</span>
    <span class="mf">0.8</span><span class="p">,</span>
    <span class="mf">0.85</span><span class="p">,</span>
    <span class="mf">0.9</span><span class="p">,</span>
    <span class="mf">0.95</span><span class="p">,</span>
    <span class="mf">0.99</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">input_chunk_length</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">forecast_horizon</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">my_model</span> <span class="o">=</span> <span class="n">TFTModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="n">input_chunk_length</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">lstm_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_attention_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">add_relative_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">add_encoders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">likelihood</span><span class="o">=</span><span class="n">QuantileRegression</span><span class="p">(</span>
        <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span>
    <span class="p">),</span>  <span class="c1"># QuantileRegression is set per default</span>
    <span class="c1"># loss_fn=MSELoss(),</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Train-the-TFT">
<h3>Train the TFT<a class="headerlink" href="#Train-the-TFT" title="Link to this heading">#</a></h3>
<p>In what follows, we can just provide the whole <code class="docutils literal notranslate"><span class="pre">covariates</span></code> series as <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> argument to the model; the model will slice these covariates and use only what it needs in order to train on forecasting the target <code class="docutils literal notranslate"><span class="pre">train_transformed</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_transformed</span><span class="p">,</span> <span class="n">future_covariates</span><span class="o">=</span><span class="n">covariates_transformed</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d6a7be1651ad4019be9435e85935349a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TFTModel(hidden_size=64, lstm_layers=1, num_attention_heads=4, full_attention=False, feed_forward=GatedResidualNetwork, dropout=0.1, hidden_continuous_size=8, categorical_embedding_sizes=None, add_relative_index=False, loss_fn=None, likelihood=&lt;darts.utils.likelihood_models.torch.QuantileRegression object at 0x7f92e0d64c70&gt;, norm_type=LayerNorm, use_static_covariates=True, input_chunk_length=24, output_chunk_length=12, batch_size=16, n_epochs=300, add_encoders=None, random_state=42)
</pre></div></div>
</div>
</section>
<section id="Look-at-predictions-on-the-validation-set">
<h3>Look at predictions on the validation set<a class="headerlink" href="#Look-at-predictions-on-the-validation-set" title="Link to this heading">#</a></h3>
<p>We perform a one-shot prediction of 24 months using the “current” model - i.e., the model at the end of the training procedure:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">actual_series</span><span class="p">,</span> <span class="n">val_series</span><span class="p">):</span>
    <span class="n">pred_series</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>

    <span class="c1"># plot actual series</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">actual_series</span><span class="p">[:</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">end_time</span><span class="p">()]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>

    <span class="c1"># plot prediction with quantile ranges</span>
    <span class="n">pred_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">low_quantile</span><span class="o">=</span><span class="n">lowest_q</span><span class="p">,</span> <span class="n">high_quantile</span><span class="o">=</span><span class="n">highest_q</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_q_outer</span>
    <span class="p">)</span>
    <span class="n">pred_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">low_quantile</span><span class="o">=</span><span class="n">low_q</span><span class="p">,</span> <span class="n">high_quantile</span><span class="o">=</span><span class="n">high_q</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_q_inner</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPE: </span><span class="si">{</span><span class="n">mape</span><span class="p">(</span><span class="n">val_series</span><span class="p">,</span><span class="w"> </span><span class="n">pred_series</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="n">eval_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">series_transformed</span><span class="p">,</span> <span class="n">val_transformed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cbee4be48a6b40ce9ce469112c0bd884", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_14_1.png" src="../_images/examples_13-TFT-examples_14_1.png" />
</div>
</div>
</section>
<section id="Backtesting">
<h3>Backtesting<a class="headerlink" href="#Backtesting" title="Link to this heading">#</a></h3>
<p>Let’s backtest our <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> model, to see how it performs with a forecast horizon of 12 months over the last 3 years:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backtest_series</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">series_transformed</span><span class="p">,</span>
    <span class="n">future_covariates</span><span class="o">=</span><span class="n">covariates_transformed</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">end_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">train</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
    <span class="n">forecast_horizon</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">,</span>
    <span class="n">last_points_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">retrain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "dcd55bc84e6f46b1b628b819ca7f2e5e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a15431f3b7934df088535980489de9e5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9df8ce5ca85b42b0a1ca2be464bf2453", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7dc52c43438342c69e07a90708477e52", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">eval_backtest</span><span class="p">(</span><span class="n">backtest_series</span><span class="p">,</span> <span class="n">actual_series</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">transformer</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">actual_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
    <span class="n">backtest_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">low_quantile</span><span class="o">=</span><span class="n">lowest_q</span><span class="p">,</span> <span class="n">high_quantile</span><span class="o">=</span><span class="n">highest_q</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_q_outer</span>
    <span class="p">)</span>
    <span class="n">backtest_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">low_quantile</span><span class="o">=</span><span class="n">low_q</span><span class="p">,</span> <span class="n">high_quantile</span><span class="o">=</span><span class="n">high_q</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_q_inner</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backtest, starting </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s2">-months horizon&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;MAPE: </span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">mape</span><span class="p">(</span>
                <span class="n">transformer</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">actual_series</span><span class="p">),</span>
                <span class="n">transformer</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">backtest_series</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="n">eval_backtest</span><span class="p">(</span>
    <span class="n">backtest_series</span><span class="o">=</span><span class="n">concatenate</span><span class="p">(</span><span class="n">backtest_series</span><span class="p">),</span>
    <span class="n">actual_series</span><span class="o">=</span><span class="n">series_transformed</span><span class="p">,</span>
    <span class="n">horizon</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="n">training_cutoff</span><span class="p">,</span>
    <span class="n">transformer</span><span class="o">=</span><span class="n">transformer</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAPE: 4.90%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_17_1.png" src="../_images/examples_13-TFT-examples_17_1.png" />
</div>
</div>
</section>
</section>
<section id="Monthly-ice-cream-sales">
<h2>Monthly ice cream sales<a class="headerlink" href="#Monthly-ice-cream-sales" title="Link to this heading">#</a></h2>
<p>Let’s try a another data set. That of monthly ice cream and heater sales since 2004. Our target is to predict future ice cream sales. First, we build the time series from the data, and check its periodicity.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series_ice_heater</span> <span class="o">=</span> <span class="n">IceCreamHeaterDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">series_ice_heater</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">check_seasonality</span><span class="p">(</span><span class="n">series_ice_heater</span><span class="p">[</span><span class="s2">&quot;ice cream&quot;</span><span class="p">],</span> <span class="n">max_lag</span><span class="o">=</span><span class="mi">36</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">check_seasonality</span><span class="p">(</span><span class="n">series_ice_heater</span><span class="p">[</span><span class="s2">&quot;heater&quot;</span><span class="p">],</span> <span class="n">max_lag</span><span class="o">=</span><span class="mi">36</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">series_ice_heater</span><span class="p">[</span><span class="s2">&quot;ice cream&quot;</span><span class="p">],</span> <span class="mi">12</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span>  <span class="c1"># ~1 year seasonality</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(True, 12)
(True, 12)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_19_1.png" src="../_images/examples_13-TFT-examples_19_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 900x600 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_19_3.png" src="../_images/examples_13-TFT-examples_19_3.png" />
</div>
</div>
<section id="Process-the-data">
<h3>Process the data<a class="headerlink" href="#Process-the-data" title="Link to this heading">#</a></h3>
<p>We again have a 12-month seasonality. This time we will not define monthly future covariates -&gt; we let the model handle this itself!</p>
<p>Let’s define past covariates instead. What if we used past data of heater sales to predict ice cream sales?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert monthly sales to average daily sales per month</span>
<span class="n">converted_series</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ice cream&quot;</span><span class="p">,</span> <span class="s2">&quot;heater&quot;</span><span class="p">]:</span>
    <span class="n">converted_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">series_ice_heater</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="o">/</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_values</span><span class="p">(</span><span class="n">series_ice_heater</span><span class="o">.</span><span class="n">time_index</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">)</span>
    <span class="p">)</span>
<span class="n">converted_series</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">converted_series</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">converted_series</span> <span class="o">=</span> <span class="n">converted_series</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;20100101&quot;</span><span class="p">)</span> <span class="p">:]</span>

<span class="c1"># define train/validation cutoff time</span>
<span class="n">forecast_horizon_ice</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">training_cutoff_ice</span> <span class="o">=</span> <span class="n">converted_series</span><span class="o">.</span><span class="n">time_index</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">forecast_horizon_ice</span><span class="p">)]</span>

<span class="c1"># use ice cream sales as target, create train and validation sets and transform data</span>
<span class="n">series_ice</span> <span class="o">=</span> <span class="n">converted_series</span><span class="p">[</span><span class="s2">&quot;ice cream&quot;</span><span class="p">]</span>
<span class="n">train_ice</span><span class="p">,</span> <span class="n">val_ice</span> <span class="o">=</span> <span class="n">series_ice</span><span class="o">.</span><span class="n">split_before</span><span class="p">(</span><span class="n">training_cutoff_ice</span><span class="p">)</span>
<span class="n">transformer_ice</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">train_ice_transformed</span> <span class="o">=</span> <span class="n">transformer_ice</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_ice</span><span class="p">)</span>
<span class="n">val_ice_transformed</span> <span class="o">=</span> <span class="n">transformer_ice</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">val_ice</span><span class="p">)</span>
<span class="n">series_ice_transformed</span> <span class="o">=</span> <span class="n">transformer_ice</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">series_ice</span><span class="p">)</span>

<span class="c1"># use heater sales as past covariates and transform data</span>
<span class="n">covariates_heat</span> <span class="o">=</span> <span class="n">converted_series</span><span class="p">[</span><span class="s2">&quot;heater&quot;</span><span class="p">]</span>
<span class="n">cov_heat_train</span><span class="p">,</span> <span class="n">cov_heat_val</span> <span class="o">=</span> <span class="n">covariates_heat</span><span class="o">.</span><span class="n">split_before</span><span class="p">(</span><span class="n">training_cutoff_ice</span><span class="p">)</span>
<span class="n">transformer_heat</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">transformer_heat</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_heat_train</span><span class="p">)</span>
<span class="n">covariates_heat_transformed</span> <span class="o">=</span> <span class="n">transformer_heat</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">covariates_heat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-a-model-with-automatically-generated-future-covariates-and-train-it">
<h3>Create a model with automatically generated future covariates and train it<a class="headerlink" href="#Create-a-model-with-automatically-generated-future-covariates-and-train-it" title="Link to this heading">#</a></h3>
<p>Since we don’t have future covariates defined, we need tell the model to generate future covariates itself.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_encoders</span></code>: can add multiple encodings as past and / or future covariates from datetime attributes, cyclic repeating temporal patterns, index positions and customm functions for index encodings. You can even add a transformer that handles proper scaling of the training, validation and prediction data! Read more about it in the <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> docs <a class="reference external" href="https://unit8co.github.io/darts/generated_api/darts.models.forecasting.tft_model.html#temporal-fusion-transformer-tft">from here</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add_relative_index</span></code>: adds a scaled integer position relative to the prediction point for each encoder-decoder chunk (this might be useful if you really don’t want to use any future covariates. The position values remain constant over all chunks and do not add additional information).</p></li>
</ul>
<p>We use <code class="docutils literal notranslate"><span class="pre">add_encoders={'cyclic':</span> <span class="pre">{'future':</span> <span class="pre">['month']}}</span></code> to account for the 12-month seasonality as a future covariate..</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the last 3 years as past input data</span>
<span class="n">input_chunk_length_ice</span> <span class="o">=</span> <span class="mi">36</span>

<span class="c1"># use `add_encoders` as we don&#39;t have future covariates</span>
<span class="n">my_model_ice</span> <span class="o">=</span> <span class="n">TFTModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="n">input_chunk_length_ice</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="n">forecast_horizon_ice</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">lstm_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">add_encoders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cyclic&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;future&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]}},</span>
    <span class="n">add_relative_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">optimizer_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">},</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># fit the model with past covariates</span>
<span class="n">my_model_ice</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_ice_transformed</span><span class="p">,</span> <span class="n">past_covariates</span><span class="o">=</span><span class="n">covariates_heat_transformed</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1041c198dedc490ea22bc176b1e7ab2f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TFTModel(hidden_size=32, lstm_layers=1, num_attention_heads=4, full_attention=False, feed_forward=GatedResidualNetwork, dropout=0.1, hidden_continuous_size=8, categorical_embedding_sizes=None, add_relative_index=False, loss_fn=None, likelihood=None, norm_type=LayerNorm, use_static_covariates=True, input_chunk_length=36, output_chunk_length=12, batch_size=16, n_epochs=300, add_encoders={&#39;cyclic&#39;: {&#39;future&#39;: [&#39;month&#39;]}}, optimizer_kwargs={&#39;lr&#39;: 0.001}, random_state=42)
</pre></div></div>
</div>
</section>
<section id="id1">
<h3>Look at predictions on the validation set<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>Again, we perform a one-shot prediction of 24 months using the “current” model - i.e., the model at the end of the training procedure:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">eval_model</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">my_model_ice</span><span class="p">,</span>
    <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
    <span class="n">actual_series</span><span class="o">=</span><span class="n">series_ice_transformed</span><span class="p">[</span>
        <span class="n">train_ice</span><span class="o">.</span><span class="n">end_time</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_ice</span><span class="o">.</span><span class="n">freq</span> <span class="p">:</span>
    <span class="p">],</span>
    <span class="n">val_series</span><span class="o">=</span><span class="n">val_ice_transformed</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a0591d71db3141f492c1f9be2eaa1925", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_25_1.png" src="../_images/examples_13-TFT-examples_25_1.png" />
</div>
</div>
</section>
<section id="id2">
<h3>Backtesting<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>Let’s backtest our <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> model, to see how it performs with a forecast horizon of 12 months over the last 2 years:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the backtest predictions with the two models</span>
<span class="n">last_points_only</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">backtest_series_ice</span> <span class="o">=</span> <span class="n">my_model_ice</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">series_ice_transformed</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="n">training_cutoff_ice</span><span class="p">,</span>
    <span class="n">forecast_horizon</span><span class="o">=</span><span class="n">forecast_horizon_ice</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">last_points_only</span> <span class="k">else</span> <span class="n">forecast_horizon_ice</span><span class="p">,</span>
    <span class="n">retrain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">last_points_only</span><span class="o">=</span><span class="n">last_points_only</span><span class="p">,</span>
    <span class="n">overlap_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">backtest_series_ice</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">concatenate</span><span class="p">(</span><span class="n">backtest_series_ice</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backtest_series_ice</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">else</span> <span class="n">backtest_series_ice</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d07f106ef1804783b2960502dd83d2b9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "87caadb2ff92406ba7dbe2235fcdac03", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2f548e656dd748d9855030bb6c3d6cdf", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_backtest</span><span class="p">(</span>
    <span class="n">backtest_series</span><span class="o">=</span><span class="n">backtest_series_ice</span><span class="p">,</span>
    <span class="n">actual_series</span><span class="o">=</span><span class="n">series_ice_transformed</span><span class="p">[</span>
        <span class="n">train_ice</span><span class="o">.</span><span class="n">start_time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">forecast_horizon_ice</span> <span class="o">*</span> <span class="n">train_ice</span><span class="o">.</span><span class="n">freq</span> <span class="p">:</span>
    <span class="p">],</span>
    <span class="n">horizon</span><span class="o">=</span><span class="n">forecast_horizon_ice</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="n">training_cutoff_ice</span><span class="p">,</span>
    <span class="n">transformer</span><span class="o">=</span><span class="n">transformer_ice</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAPE: 5.32%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_28_1.png" src="../_images/examples_13-TFT-examples_28_1.png" />
</div>
</div>
</section>
<section id="Explainability">
<h3>Explainability<a class="headerlink" href="#Explainability" title="Link to this heading">#</a></h3>
<p>Let’s try to understand what our <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> model has learned. It would be nice to see the feature importance and how much the model attentds to past and future input.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TFTExplainer</span></code> does exactly that! You can find the documentation <a class="reference external" href="https://unit8co.github.io/darts/generated_api/darts.explainability.tft_explainer.html">here</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">darts.explainability</span><span class="w"> </span><span class="kn">import</span> <span class="n">TFTExplainer</span>
</pre></div>
</div>
</div>
<p>To instantiate the explainer we have two options:</p>
<ul class="simple">
<li><p>pass a custom background series input to be used as the default input for explanation.</p></li>
<li><p>let the explainer load the background from the model automatically. This is only possible if the model was trained on a single target series (as in our case).</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">TFTExplainer</span><span class="p">(</span><span class="n">my_model_ice</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can generate the explanations with <code class="docutils literal notranslate"><span class="pre">explain()</span></code>. For this we again have two options:</p>
<ul class="simple">
<li><p>pass a custom foreground series input to be explained</p></li>
<li><p>don’t pass any foreground to explain the background</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainability_result</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7218380ecc11445e97a6eac5c7db45e3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Let’s look at the feature importances:</p>
<ul class="simple">
<li><p>encoder feature importance: contains past target, past covariates and “historic” future covariates (the values of future covariates in the input chunk)</p></li>
<li><p>decoder fetaure importance: contains “future” future covariates (the values of future covariates in the output chunk)</p></li>
<li><p>static covariates importance: the importances of the static variables (only displayed if the model was trained on <code class="docutils literal notranslate"><span class="pre">series</span></code> with static covariates)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainer</span><span class="o">.</span><span class="n">plot_variable_selection</span><span class="p">(</span><span class="n">explainability_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_36_0.png" src="../_images/examples_13-TFT-examples_36_0.png" />
</div>
</div>
<p>As expected, the past history of ice cream sales is the most important feature in the encoder. The cyclic encoding of the month also helped in the encoder and decoder to learn seasonal patterns.</p>
<p>Let’s look at the attention (weights) that the model put on past and future input.</p>
<p>We have multiple plotting options:</p>
<p><code class="docutils literal notranslate"><span class="pre">plot_type</span></code></p>
<ul class="simple">
<li><p>“time” - plots the attention aggregated over all predictions steps</p></li>
<li><p>“all” - plots the attention for each prediction step individually (ranges from <code class="docutils literal notranslate"><span class="pre">1</span></code> until <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>)</p></li>
<li><p>“heatmap” - plots all the attention for each prediction step as a heatmap</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">show_index_as</span></code></p>
<ul class="simple">
<li><p>“relative” - sets the x-axis relative to the first predicted time step, ranging from <code class="docutils literal notranslate"><span class="pre">-input_chunk_length</span></code> until <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span> <span class="pre">-</span> <span class="pre">1</span></code>. <code class="docutils literal notranslate"><span class="pre">0</span></code> indicates the first predicted time step (highlighted by a dashed line).</p></li>
<li><p>“time” - Uses the actual time index on the x-axis. The dashed line highlights the first predicted time step.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainer</span><span class="o">.</span><span class="n">plot_attention</span><span class="p">(</span><span class="n">explainability_result</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_39_0.png" src="../_images/examples_13-TFT-examples_39_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Attention per Horizon&#39;}, xlabel=&#39;Index relative to first prediction point&#39;, ylabel=&#39;Attention&#39;&gt;
</pre></div></div>
</div>
<p>We can see interesting attention areas:</p>
<ul class="simple">
<li><p>maximum attention at relative index -12. This indicates a yearly seasonality which makes sense for ice cream sales.</p></li>
<li><p>high attention at the start (-36) of the input chunk: this is probably both from catching the value range of current input and the seasonality (-3 years)</p></li>
<li><p>higher attention towards the end (-1) of the input chunk: the model puts attention on the recent past</p></li>
<li><p>attention on future input (we look at this more in the next plot)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainer</span><span class="o">.</span><span class="n">plot_attention</span><span class="p">(</span><span class="n">explainability_result</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_41_0.png" src="../_images/examples_13-TFT-examples_41_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Mean Attention&#39;}, xlabel=&#39;Index relative to first prediction point&#39;, ylabel=&#39;Attention&#39;&gt;
</pre></div></div>
</div>
<p>On the output chunk (index 0 - 11), we see that the model only attends to the past relative of each horizon. This is because <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> uses <code class="docutils literal notranslate"><span class="pre">full_attention=False</span></code> by default. When setting this to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the model will also attend to current, and future input.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainer</span><span class="o">.</span><span class="n">plot_attention</span><span class="p">(</span><span class="n">explainability_result</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;heatmap&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_43_0.png" src="../_images/examples_13-TFT-examples_43_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Attention Heat Map&#39;}, xlabel=&#39;Index relative to first prediction point&#39;, ylabel=&#39;Horizon&#39;&gt;
</pre></div></div>
</div>
<p>We can also get the values directly from the <code class="docutils literal notranslate"><span class="pre">exlainability_result</span></code>. You can find the documentation <a class="reference external" href="https://unit8co.github.io/darts/generated_api/darts.explainability.explainability_result.html#darts.explainability.explainability_result.TFTExplainabilityResult">here</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainability_result</span><span class="o">.</span><span class="n">get_encoder_importance</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>darts_enc_fc_cyc_month_sin</th>
      <th>heater</th>
      <th>darts_enc_fc_cyc_month_cos</th>
      <th>ice cream</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.7</td>
      <td>4.8</td>
      <td>6.8</td>
      <td>84.7</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainability_result</span><span class="o">.</span><span class="n">get_decoder_importance</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>darts_enc_fc_cyc_month_sin</th>
      <th>darts_enc_fc_cyc_month_cos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10.2</td>
      <td>89.8</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainability_result</span><span class="o">.</span><span class="n">get_static_covariates_importance</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div></div>
</div>
<p>We can also extract the attention as a TimeSeries, and plot it against the data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attention</span> <span class="o">=</span> <span class="n">explainability_result</span><span class="o">.</span><span class="n">get_attention</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">time_intersection</span> <span class="o">=</span> <span class="n">train_ice_transformed</span><span class="o">.</span><span class="n">time_index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">attention</span><span class="o">.</span><span class="n">time_index</span><span class="p">)</span>

<span class="n">train_ice_transformed</span><span class="p">[</span><span class="n">time_intersection</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">attention</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;mean_attention&quot;</span><span class="p">,</span> <span class="n">max_nr_components</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_13-TFT-examples_49_0.png" src="../_images/examples_13-TFT-examples_49_0.png" />
</div>
</div>
</section>
<section id="Some-more-information">
<h3>Some more information<a class="headerlink" href="#Some-more-information" title="Link to this heading">#</a></h3>
<p>Although we have only looked at a single univariate forecasting example, the <code class="docutils literal notranslate"><span class="pre">TFTExplainer</span></code> can be seemlessly applied to multivariate and / or multiple <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> use cases.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="09-DeepTCN-examples.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">DeepTCN model</p>
      </div>
    </a>
    <a class="right-next"
       href="18-TiDE-examples.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">TimeSeries Deep Encoder</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Temporal-Fusion-Transformer-(TFT)">Temporal Fusion Transformer (TFT)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Training">Training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Forecast">Forecast</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#Probabilistic-Forecast">Probabilistic Forecast</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#Deterministic-Forecast">Deterministic Forecast</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Air-Passenger-Example">Air Passenger Example</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Create-a-model">Create a model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Train-the-TFT">Train the TFT</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Look-at-predictions-on-the-validation-set">Look at predictions on the validation set</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Backtesting">Backtesting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Monthly-ice-cream-sales">Monthly ice cream sales</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Process-the-data">Process the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Create-a-model-with-automatically-generated-future-covariates-and-train-it">Create a model with automatically generated future covariates and train it</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Look at predictions on the validation set</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Backtesting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Explainability">Explainability</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Some-more-information">Some more information</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples/13-TFT-examples.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2020 - 2026, Unit8 SA (Apache 2.0 License).
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>