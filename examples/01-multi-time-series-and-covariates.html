
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Multiple Time Series, Pre-trained Models and Covariates &#8212; darts  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d50e28e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=7aa11fa7"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/01-multi-time-series-and-covariates';</script>
    <link rel="icon" href="../_static/docs-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data (pre) processing using DataTransformer and Pipeline" href="02-data-processing.html" />
    <link rel="prev" title="Examples" href="../examples.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.39.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/darts-logo-light.png" class="logo__image only-light" alt="darts  documentation - Home"/>
    <img src="../_static/darts-logo-dark.png" class="logo__image only-dark pst-js-only" alt="darts  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../quickstart/00-quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../generated_api/darts.html">
    API Reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release_notes/RELEASE_NOTES.html">
    Release Notes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/unit8co/darts" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/unit8co" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../quickstart/00-quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../generated_api/darts.html">
    API Reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release_notes/RELEASE_NOTES.html">
    Release Notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/unit8co/darts" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/unit8co" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Multiple Time Series, Pre-trained Models and Covariates</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="02-data-processing.html">Data (pre) processing using <code class="docutils literal notranslate"><span class="pre">DataTransformer</span></code> and <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="15-static-covariates.html">Static Covariates</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="14-transfer-learning.html">Transfer Learning for Time Series Forecasting with Darts</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="16-hierarchical-reconciliation.html">Hierarchical Reconciliation - Example on the Australian Tourism Dataset</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="17-hyperparameter-optimization.html">Hyper-parameters Optimization for Electricity Load Forecasting</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="20-SKLearnModel-examples.html">Regression Models</a></li>

</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="24-SKLearnClassifierModel-examples.html">Classification Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="23-Conformal-Prediction-examples.html">Conformal Prediction Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="03-FFT-examples.html">Fast Fourier Transform Forecasting Model (FFT)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="04-RNN-examples.html">Recurrent Neural Networks Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="05-TCN-examples.html">Temporal Convolutional Network</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="06-Transformer-examples.html">Transformer Model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="07-NBEATS-examples.html">N-BEATS</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="08-DeepAR-examples.html">Probabilistic RNN</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="09-DeepTCN-examples.html">DeepTCN model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="13-TFT-examples.html">Temporal Fusion Transformer</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="18-TiDE-examples.html">TimeSeries Deep Encoder</a></li>




</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="21-TSMixer-examples.html">Time Series Mixer (TSMixer)</a></li>






</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="25-Chronos-2-examples.html">Chronos-2 Foundation Model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="19-EnsembleModel-examples.html">Ensembling Models</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="10-Kalman-filter-examples.html">Filtering and predicting using the darts filters</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="11-GP-filter-examples.html">Filtering and predicting using the Gaussian Process filter</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="22-anomaly-detection-examples.html">Anomaly Detection Darts Module</a></li>




</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="12-Dynamic-Time-Warping-example.html">Dynamic Time Warping (DTW)</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../examples.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Multiple Time Series, Pre-trained Models and Covariates</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Multiple-Time-Series,-Pre-trained-Models-and-Covariates">
<h1>Multiple Time Series, Pre-trained Models and Covariates<a class="headerlink" href="#Multiple-Time-Series,-Pre-trained-Models-and-Covariates" title="Link to this heading">#</a></h1>
<p>This notebook serves as a tutorial for:</p>
<ul class="simple">
<li><p>Training a single model on multiple time series</p></li>
<li><p>Using a pre-trained model to obtain forecasts for any time series unseen during training</p></li>
<li><p>Training and using a model using covariates</p></li>
<li><p>Training and using a model using one or several multivariates TimeSeries</p></li>
</ul>
<p>First, some necessary imports:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fix python path if working locally</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">fix_pythonpath_if_working_locally</span>

<span class="n">fix_pythonpath_if_working_locally</span><span class="p">()</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="c1"># use darts plotting style</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_option</span>

<span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;plotting.use_darts_style&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">darts</span><span class="w"> </span><span class="kn">import</span> <span class="n">concatenate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.dataprocessing.transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AirPassengersDataset</span><span class="p">,</span> <span class="n">ElectricityDataset</span><span class="p">,</span> <span class="n">MonthlyMilkDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mae</span><span class="p">,</span> <span class="n">mape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VARIMA</span><span class="p">,</span>
    <span class="n">BlockRNNModel</span><span class="p">,</span>
    <span class="n">NBEATSModel</span><span class="p">,</span>
    <span class="n">RNNModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">TFMProgressBar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">darts.utils.timeseries_generation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime_attribute_timeseries</span><span class="p">,</span>
    <span class="n">sine_timeseries</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># for reproducibility</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_torch_kwargs</span><span class="p">():</span>
    <span class="c1"># run torch models on CPU, and disable progress bars for all model stages except training.</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;pl_trainer_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;accelerator&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">TFMProgressBar</span><span class="p">(</span><span class="n">enable_train_bar_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<section id="Read-Data">
<h2>Read Data<a class="headerlink" href="#Read-Data" title="Link to this heading">#</a></h2>
<p>Let’s start by reading two time series - one containing the monthly number of air passengers, and another containing the monthly milk production per cow. These time series have not much to do with each other, except that they both have a monthly frequency with a marked yearly periodicity and upward trend, and (completely coincidentaly) they contain values of a comparable order of magnitude.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series_air</span> <span class="o">=</span> <span class="n">AirPassengersDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">series_milk</span> <span class="o">=</span> <span class="n">MonthlyMilkDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">series_air</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Number of air passengers&quot;</span><span class="p">)</span>
<span class="n">series_milk</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pounds of milk produced per cow&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_3_0.png" src="../_images/examples_01-multi-time-series-and-covariates_3_0.png" />
</div>
</div>
</section>
<section id="Preprocessing">
<h2>Preprocessing<a class="headerlink" href="#Preprocessing" title="Link to this heading">#</a></h2>
<p>Usually neural networks tend to work better on normalised/standardised data. Here we’ll use the <code class="docutils literal notranslate"><span class="pre">Scaler</span></code> class to normalise both of our time series between 0 and 1:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler_air</span><span class="p">,</span> <span class="n">scaler_milk</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">(),</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">series_air_scaled</span> <span class="o">=</span> <span class="n">scaler_air</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series_air</span><span class="p">)</span>
<span class="n">series_milk_scaled</span> <span class="o">=</span> <span class="n">scaler_milk</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series_milk</span><span class="p">)</span>

<span class="n">series_air_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;air&quot;</span><span class="p">)</span>
<span class="n">series_milk_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;milk&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_5_0.png" src="../_images/examples_01-multi-time-series-and-covariates_5_0.png" />
</div>
</div>
</section>
<section id="Train-/-Validation-split">
<h2>Train / Validation split<a class="headerlink" href="#Train-/-Validation-split" title="Link to this heading">#</a></h2>
<p>Let’s keep the last 36 months of both series as validation:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_air</span><span class="p">,</span> <span class="n">val_air</span> <span class="o">=</span> <span class="n">series_air_scaled</span><span class="p">[:</span><span class="o">-</span><span class="mi">36</span><span class="p">],</span> <span class="n">series_air_scaled</span><span class="p">[</span><span class="o">-</span><span class="mi">36</span><span class="p">:]</span>
<span class="n">train_milk</span><span class="p">,</span> <span class="n">val_milk</span> <span class="o">=</span> <span class="n">series_milk_scaled</span><span class="p">[:</span><span class="o">-</span><span class="mi">36</span><span class="p">],</span> <span class="n">series_milk_scaled</span><span class="p">[</span><span class="o">-</span><span class="mi">36</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<section id="Global-Forecasting-Models">
<h3>Global Forecasting Models<a class="headerlink" href="#Global-Forecasting-Models" title="Link to this heading">#</a></h3>
<p>Darts contains many forecasting models, but not all of them can be trained on several time series. The models that support training on multiple series are called <em>global</em> models. An exhaustive list of the global models can be found <a class="reference external" href="https://unit8co.github.io/darts/README.html#forecasting-models">here</a> (bottom of the table) with for example:</p>
<ul class="simple">
<li><p>LinearRegressionModel</p></li>
<li><p>BlockRNNModel</p></li>
<li><p>Temporal Convolutional Networks (TCNModel)</p></li>
<li><p>N-Beats (NBEATSModel)</p></li>
<li><p>TiDEModel</p></li>
</ul>
<p>In the following, we will distinguish two sorts of time series:</p>
<ul class="simple">
<li><p>The <strong>target time series</strong> is the time series we are interested to forecast (given its history)</p></li>
<li><p>A <strong>covariate time series</strong> is a time series which may help in the forecasting of the target series, but that we are not interested in forecasting. It’s sometimes also called <em>external data</em>.</p></li>
</ul>
<p><strong>Note</strong>: Static covariates are invariant in time and correspond to additional information associated with the components of the <strong>target time series</strong>. Detailed information about this kind of covariate can be found in the <a class="reference external" href="https://unit8co.github.io/darts/examples/15-static-covariates.html">static covariates notebook</a>.</p>
<p>We further differentiate covariates series, depending on whether they can be known in advance or not:</p>
<ul class="simple">
<li><p><strong>Past Covariates</strong> denote time series whose past values are known at prediction time. These are usually things that have to be measured or observed.</p></li>
<li><p><strong>Future Covariates</strong> denote time series whose future values are already known at prediction time for the span of the forecast horizon. These can for instance represent known future holidays, or weather forecasts.</p></li>
</ul>
<p>Some models use only past covariates, others use only future covariates, and some models might use both. We will dive deeper in this topic in some other notebook, but this <a class="reference external" href="https://unit8co.github.io/darts/README.html#forecasting-models">table</a> details the covariates supported by each model.</p>
<p>All of the global models listed above support training on multiple series. In addition, they also all support <em>multivariate series</em>. This means that they can seamlessly be used with time series of more than one dimension; the target series can contain one (as is often the case) or several dimensions. A time series with several dimensions is really just a regular time series where the values at each time stamps are vectors instead of scalars.</p>
<p>As an example, the BlockRNNModel, N-Beats, TCN and Transformer models follow a “block” architecture. They contain a neural network that takes chunks of time series in input, and outputs chunks of (predicted) future time series values. The input dimensionality is the number of dimensions (components) of the target series, plus the number of components of all the covariates - stacked together. The output dimensionality is simply the number of dimensions of the target series: <img alt="image1" src="../_images/global_io_covs.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">RNNModel</span></code> works differently, in a recurrent fashion (which is also why they support future covariates). The good news is that as a user, we don’t have to worry too much about the different model types and input/output dimensionalities. The dimensionalities are automatically inferred for us by the model based on the training data, and the support for past or future covariates is simply handled by the <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> or <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> arguments.</p>
<p>We’ll still have to specify two important parameters when building our models:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code>: this is the length of the lookback window of the model; so each output will be computed by the model by reading the previous <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code> points.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>: this is the length of the outputs (forecasts) produced by the internal model. However, the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method of the “outer” Darts model (e.g., the one of <code class="docutils literal notranslate"><span class="pre">NBEATSModel</span></code>, <code class="docutils literal notranslate"><span class="pre">TCNModel</span></code>, etc) can be called for a longer time horizon. In these cases, if <code class="docutils literal notranslate"><span class="pre">predict()</span></code> is called for a horizon longer than <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>, the internal model will simply be called repeatedly, feeding on its own previous outputs in an auto-regressive fashion. If <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code>
are used it requires these covariates to be known for long enough in advance.</p></li>
</ul>
</section>
</section>
<section id="Example-with-one-Series">
<h2>Example with one Series<a class="headerlink" href="#Example-with-one-Series" title="Link to this heading">#</a></h2>
<p>Let’s look at a first example. We’ll build an N-BEATS model that has a lookback window of 24 points (<code class="docutils literal notranslate"><span class="pre">input_chunk_length=24</span></code>) and predicts the next 12 points (<code class="docutils literal notranslate"><span class="pre">output_chunk_length=12</span></code>). We chose these values so it’ll make our model produce successive predictions for one year at a time, looking at the past two years.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_air</span> <span class="o">=</span> <span class="n">NBEATSModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">generate_torch_kwargs</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>This model can be used like any other Darts forecasting model, beeing fit on a single time series:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_air</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_air</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f13ab7bf59874aaba64679b11697e3a8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NBEATSModel(generic_architecture=True, num_stacks=30, num_blocks=1, num_layers=4, layer_widths=256, expansion_coefficient_dim=5, trend_polynomial_degree=2, dropout=0.0, activation=ReLU, input_chunk_length=24, output_chunk_length=12, n_epochs=200, random_state=0, pl_trainer_kwargs={&#39;accelerator&#39;: &#39;cpu&#39;, &#39;callbacks&#39;: [&lt;darts.utils.callbacks.TFMProgressBar object at 0x103d1a710&gt;]})
</pre></div></div>
</div>
<p>And like any other Darts forecasting models, we can then get a forecast by calling <code class="docutils literal notranslate"><span class="pre">predict()</span></code>. Note that below, we are calling <code class="docutils literal notranslate"><span class="pre">predict()</span></code> with a horizon of 36, which is longer than the model internal <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code> of 12. That’s not a problem here - as explained above, in such a case the internal model will simply be called auto-regressively on its own outputs. In this case, it will be called three times so that the three 12-points outputs make up the final 36-points forecast -
but all of this is done transparently behind the scenes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred</span> <span class="o">=</span> <span class="n">model_air</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span>

<span class="n">series_air_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPE = </span><span class="si">{</span><span class="n">mape</span><span class="p">(</span><span class="n">series_air_scaled</span><span class="p">,</span><span class="w"> </span><span class="n">pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAPE = 8.02%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_13_1.png" src="../_images/examples_01-multi-time-series-and-covariates_13_1.png" />
</div>
</div>
</section>
<section id="Training-Process-(behind-the-scenes)">
<h2>Training Process (behind the scenes)<a class="headerlink" href="#Training-Process-(behind-the-scenes)" title="Link to this heading">#</a></h2>
<p>So what happened when we called <code class="docutils literal notranslate"><span class="pre">model_air.fit()</span></code> above?</p>
<p>In order to train the internal neural network, Darts first makes a dataset of inputs/outputs examples from the provided time series (in this case: <code class="docutils literal notranslate"><span class="pre">series_air_scaled</span></code>). There are several ways this can be done and Darts contains a few different dataset implementations in the <code class="docutils literal notranslate"><span class="pre">darts.utils.data</span></code> package.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">NBEATSModel</span></code> will instantiate a <code class="docutils literal notranslate"><span class="pre">darts.utils.data.SequentialTorchTrainingDataset</span></code>, which simply builds all the consecutive pairs of input/output sub-sequences (of lengths <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code> and <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>) existing in the series).</p>
<p>For an example series of length 14, with <code class="docutils literal notranslate"><span class="pre">input_chunk_length=4</span></code> and <code class="docutils literal notranslate"><span class="pre">output_chunk_length=2</span></code>, it looks as follows: <img alt="image2" src="../_images/seq_dataset_one_ts.png" /></p>
<p>For such a dataset, a series of length <code class="docutils literal notranslate"><span class="pre">N</span></code> would result in a “training set” of <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">-</span> <span class="pre">input_chunk_length</span> <span class="pre">-</span> <span class="pre">output_chunk_length</span> <span class="pre">+</span> <span class="pre">1</span></code> samples. In the toy example above, we have <code class="docutils literal notranslate"><span class="pre">N=14</span></code>, <code class="docutils literal notranslate"><span class="pre">input_chunk_length=4</span></code> and <code class="docutils literal notranslate"><span class="pre">output_chunk_length=2</span></code>, so the number of samples used for training would be K = 9. In this context, a training <em>epoch</em> consists in complete pass (possibly consisting of several mini-batches) over all the samples.</p>
<p>Note that different models are susceptible to use different datasets by default. For instance, <code class="docutils literal notranslate"><span class="pre">darts.utils.data.HorizonBasedTorchTrainingDataset</span></code> is inspired by the <a class="reference external" href="https://arxiv.org/abs/1905.10437">N-BEATS paper</a> and produces samples that are “close” to the end of the series, possibly even ignoring the beginning of the series.</p>
<p>If you have the need to control the way training samples are produced from <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> instances, you can implement your own training dataset by inheriting the abstract <code class="docutils literal notranslate"><span class="pre">darts.utils.data.TorchTrainingDataset</span></code> class. Darts datasets are inheriting from torch <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>, which means it’s easy to implement lazy versions that do not load all data in memory at once. Once you have your own instance of a dataset, you can directly call the <code class="docutils literal notranslate"><span class="pre">fit_from_dataset()</span></code> method, which is supported by all
global forecasting models.</p>
<section id="Training-a-Model-on-Multiple-Time-Series">
<h3>Training a Model on Multiple Time Series<a class="headerlink" href="#Training-a-Model-on-Multiple-Time-Series" title="Link to this heading">#</a></h3>
<p>All this machinery can be seamlessly used with multiple time series. Here’s how a sequential dataset with <code class="docutils literal notranslate"><span class="pre">input_chunk_length=4</span></code> and <code class="docutils literal notranslate"><span class="pre">output_chunk_length=2</span></code> looks for two series of lengths N and M:</p>
<img alt="image3" src="../_images/seq_dataset_multi_ts.png" />
<p>Note a few things here:</p>
<ul class="simple">
<li><p>The different series do not need to have the same length, or even to share the same time stamps.</p></li>
<li><p>In fact, they don’t even need to have the same frequency.</p></li>
<li><p>The total number of samples in the training dataset will be the union of all the training samples contained in each series; so a training epoch will now span all samples from all series.</p></li>
</ul>
</section>
</section>
<section id="Training-on-Both-Air-Traffic-and-Milk-Series">
<h2>Training on Both Air Traffic and Milk Series<a class="headerlink" href="#Training-on-Both-Air-Traffic-and-Milk-Series" title="Link to this heading">#</a></h2>
<p>Let’s look at another example where we fit another model instance on our two time series (air passengers and milk production). Since using two series of (roughly) the same length (roughly) doubles the training dataset size, we will use half of the number of epochs:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_air_milk</span> <span class="o">=</span> <span class="n">NBEATSModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">generate_torch_kwargs</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then, fitting the model on two (or more) series is as simple as giving a list of series (instead of a single series) in argument to the <code class="docutils literal notranslate"><span class="pre">fit()</span></code> function:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_air_milk</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="n">train_air</span><span class="p">,</span> <span class="n">train_milk</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4d958219d6ba4fec91343c20b80482a5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NBEATSModel(generic_architecture=True, num_stacks=30, num_blocks=1, num_layers=4, layer_widths=256, expansion_coefficient_dim=5, trend_polynomial_degree=2, dropout=0.0, activation=ReLU, input_chunk_length=24, output_chunk_length=12, n_epochs=100, random_state=0, pl_trainer_kwargs={&#39;accelerator&#39;: &#39;cpu&#39;, &#39;callbacks&#39;: [&lt;darts.utils.callbacks.TFMProgressBar object at 0x2af748f10&gt;]})
</pre></div></div>
</div>
</section>
<section id="Producing-Forecasts-After-the-End-of-a-Series">
<h2>Producing Forecasts After the End of a Series<a class="headerlink" href="#Producing-Forecasts-After-the-End-of-a-Series" title="Link to this heading">#</a></h2>
<p>Now, importantly, when computing the forecasts we have to specify which time series we want to forecast the future for.</p>
<p>We didn’t have this constraint earlier. When fitting models on one series only, the model remembers this series internally, and if <code class="docutils literal notranslate"><span class="pre">predict()</span></code> is called without the <code class="docutils literal notranslate"><span class="pre">series</span></code> argument, it returns a forecast for the (unique) training series. This does not work anymore as soon as a model is fit on more than one series - in this case the <code class="docutils literal notranslate"><span class="pre">series</span></code> argument of <code class="docutils literal notranslate"><span class="pre">predict()</span></code> becomes mandatory.</p>
<p>So, let’s say we want to predict future of air traffic. In this case we specify <code class="docutils literal notranslate"><span class="pre">series=train_air</span></code> to the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function in order to say we want to get a forecast for what comes after <code class="docutils literal notranslate"><span class="pre">train_air</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred</span> <span class="o">=</span> <span class="n">model_air_milk</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">train_air</span><span class="p">)</span>

<span class="n">series_air_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPE = </span><span class="si">{</span><span class="n">mape</span><span class="p">(</span><span class="n">series_air_scaled</span><span class="p">,</span><span class="w"> </span><span class="n">pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAPE = 7.58%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_20_1.png" src="../_images/examples_01-multi-time-series-and-covariates_20_1.png" />
</div>
</div>
<section id="Wait...-does-this-mean-that-milk-production-helps-to-predict-air-traffic??">
<h3>Wait… does this mean that milk production helps to predict air traffic??<a class="headerlink" href="#Wait...-does-this-mean-that-milk-production-helps-to-predict-air-traffic??" title="Link to this heading">#</a></h3>
<p>Well, in this particular instance with this model, it seems to be the case (at least in terms of MAPE error). This is not so weird if you think about it, though. Air traffic is heavily characterized by the yearly seasonality and upward trend. The milk series exhibits these two traits as well, and in this case it’s probably helping the model to capture them.</p>
<p>Note that this points towards the possibility of <em>pre-training</em> forecasting models; training models once and for all and later using them to forecast series that are not in the train set. With our toy model we can really forecast the future values of any other series, even series never seen during training. For the sake of example, let’s say we want to forecast the future of some arbitrary sine wave series:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">any_series</span> <span class="o">=</span> <span class="n">sine_timeseries</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">model_air_milk</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">any_series</span><span class="p">)</span>

<span class="n">any_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&quot;any series, really&quot;&#39;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x2af20d5d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_22_1.png" src="../_images/examples_01-multi-time-series-and-covariates_22_1.png" />
</div>
</div>
<p>This forecast isn’t good (the sine doesn’t even have a yearly seasonality), but you get the idea.</p>
<p>Similar to what is supported by the <code class="docutils literal notranslate"><span class="pre">fit()</span></code> function, we can also give a list of series in argument to the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function, in which case it will return a list of forecast series. For example, we can get the forecasts for both the air traffic and the milk series in one go as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_list</span> <span class="o">=</span> <span class="n">model_air_milk</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="p">[</span><span class="n">train_air</span><span class="p">,</span> <span class="n">train_milk</span><span class="p">])</span>
<span class="k">for</span> <span class="n">series</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pred_list</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;air passengers&quot;</span><span class="p">,</span> <span class="s2">&quot;milk production&quot;</span><span class="p">]):</span>
    <span class="n">series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;forecast </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x2b56bb9d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_24_1.png" src="../_images/examples_01-multi-time-series-and-covariates_24_1.png" />
</div>
</div>
<p>The two series returned correspond to the forecasts after the end of <code class="docutils literal notranslate"><span class="pre">train_air</span></code> and <code class="docutils literal notranslate"><span class="pre">train_milk</span></code>, respectively.</p>
</section>
<section id="Covariates-Series">
<h3>Covariates Series<a class="headerlink" href="#Covariates-Series" title="Link to this heading">#</a></h3>
<p>Until now, we have only been playing with models that only use the history of the <em>target</em> series to predict its future. However, as explained above, the global Darts models also support the use of <em>covariates</em> time series. These are time series of “external data”, which we are not necessarily interested in predicting, but which we would still like to feed as input of our models because they can contain valuable information.</p>
<section id="Building-Covariates">
<h4>Building Covariates<a class="headerlink" href="#Building-Covariates" title="Link to this heading">#</a></h4>
<p>Let’s see a simple example with our air and milk series, where we’ll try to use the year and month-of-the-year as covariates:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># build year and month series:</span>
<span class="n">air_year</span> <span class="o">=</span> <span class="n">datetime_attribute_timeseries</span><span class="p">(</span><span class="n">series_air_scaled</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
<span class="n">air_month</span> <span class="o">=</span> <span class="n">datetime_attribute_timeseries</span><span class="p">(</span><span class="n">series_air_scaled</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>

<span class="n">milk_year</span> <span class="o">=</span> <span class="n">datetime_attribute_timeseries</span><span class="p">(</span><span class="n">series_milk_scaled</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
<span class="n">milk_month</span> <span class="o">=</span> <span class="n">datetime_attribute_timeseries</span><span class="p">(</span><span class="n">series_milk_scaled</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>

<span class="c1"># stack year and month to obtain series of 2 dimensions (year and month):</span>
<span class="n">air_covariates</span> <span class="o">=</span> <span class="n">air_year</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">air_month</span><span class="p">)</span>
<span class="n">milk_covariates</span> <span class="o">=</span> <span class="n">milk_year</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">milk_month</span><span class="p">)</span>

<span class="c1"># split in train/validation sets:</span>
<span class="n">air_train_covariates</span><span class="p">,</span> <span class="n">air_val_covariates</span> <span class="o">=</span> <span class="n">air_covariates</span><span class="p">[:</span><span class="o">-</span><span class="mi">36</span><span class="p">],</span> <span class="n">air_covariates</span><span class="p">[</span><span class="o">-</span><span class="mi">36</span><span class="p">:]</span>
<span class="n">milk_train_covariates</span><span class="p">,</span> <span class="n">milk_val_covariates</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">milk_covariates</span><span class="p">[:</span><span class="o">-</span><span class="mi">36</span><span class="p">],</span>
    <span class="n">milk_covariates</span><span class="p">[</span><span class="o">-</span><span class="mi">36</span><span class="p">:],</span>
<span class="p">)</span>

<span class="c1"># scale them between 0 and 1:</span>
<span class="n">scaler_covariates</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="n">air_train_covariates</span><span class="p">,</span> <span class="n">milk_train_covariates</span> <span class="o">=</span> <span class="n">scaler_covariates</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span>
    <span class="n">air_train_covariates</span><span class="p">,</span>
    <span class="n">milk_train_covariates</span><span class="p">,</span>
<span class="p">])</span>
<span class="n">air_val_covariates</span><span class="p">,</span> <span class="n">milk_val_covariates</span> <span class="o">=</span> <span class="n">scaler_covariates</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span>
    <span class="n">air_val_covariates</span><span class="p">,</span>
    <span class="n">milk_val_covariates</span><span class="p">,</span>
<span class="p">])</span>

<span class="c1"># concatenate for the full scaled series; we can feed this to model.fit()/predict() as Darts will extract the required</span>
<span class="c1"># covariates for you</span>
<span class="n">air_covariates</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">air_train_covariates</span><span class="p">,</span> <span class="n">air_val_covariates</span><span class="p">])</span>
<span class="n">milk_covariates</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">milk_train_covariates</span><span class="p">,</span> <span class="n">milk_val_covariates</span><span class="p">])</span>

<span class="c1"># plot the covariates:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">air_covariates</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Air traffic covariates (year and month)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">milk_covariates</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Milk production covariates (year and month)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Milk production covariates (year and month)&#39;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_27_1.png" src="../_images/examples_01-multi-time-series-and-covariates_27_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_27_2.png" src="../_images/examples_01-multi-time-series-and-covariates_27_2.png" />
</div>
</div>
<p>Good, so for each target series (air and milk), we have built a covariates series having the same time axis and containing the year and the month.</p>
<p>Note that here the covariates series are <strong>multivariate time series</strong>: they contain two dimensions - one dimension for the year and one for the month.</p>
</section>
</section>
</section>
<section id="Training-with-Covariates">
<h2>Training with Covariates<a class="headerlink" href="#Training-with-Covariates" title="Link to this heading">#</a></h2>
<p>Let’s revisit our example again, this time with covariates. We will build a <code class="docutils literal notranslate"><span class="pre">BlockRNNModel</span></code> here. We activate checkpointing to keep track of the model performance on a validation set over time.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;BlockRNN_test&quot;</span>
<span class="n">model_pastcov</span> <span class="o">=</span> <span class="n">BlockRNNModel</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
    <span class="n">save_checkpoints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># store model states: latest and best performing of validation set</span>
    <span class="n">force_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">generate_torch_kwargs</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now, to train the model with covariates, it is as simple as providing the covariates (in form of a list matching the target series) as <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> argument to the <code class="docutils literal notranslate"><span class="pre">fit()</span></code> function. The argument is named <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> to remind us that the model can use past values of these covariates in order to make a prediction. We can feed the entire air and milk covariates including the train and test sets to model.fit()/predict() as Darts will automatically extract the required covariates
for you.</p>
<p>Aditionally, we pass a validation series to avoid model overfitting.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_pastcov</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="p">[</span><span class="n">train_air</span><span class="p">,</span> <span class="n">train_milk</span><span class="p">],</span>
    <span class="n">past_covariates</span><span class="o">=</span><span class="p">[</span><span class="n">air_covariates</span><span class="p">,</span> <span class="n">milk_covariates</span><span class="p">],</span>
    <span class="n">val_series</span><span class="o">=</span><span class="p">[</span><span class="n">val_air</span><span class="p">,</span> <span class="n">val_milk</span><span class="p">],</span>
    <span class="n">val_past_covariates</span><span class="o">=</span><span class="p">[</span><span class="n">air_covariates</span><span class="p">,</span> <span class="n">milk_covariates</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d505fa9d752547b9b04d40c27dd7971a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BlockRNNModel(model=LSTM, hidden_dim=25, n_rnn_layers=1, hidden_fc_sizes=None, dropout=0.0, input_chunk_length=24, output_chunk_length=12, n_epochs=100, random_state=0, model_name=BlockRNN_test, save_checkpoints=True, force_reset=True, pl_trainer_kwargs={&#39;accelerator&#39;: &#39;cpu&#39;, &#39;callbacks&#39;: [&lt;darts.utils.callbacks.TFMProgressBar object at 0x2b56bb640&gt;]})
</pre></div></div>
</div>
<p>Now we load the model state with the best performance on the validation set to avoid overfitting.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_pastcov</span> <span class="o">=</span> <span class="n">BlockRNNModel</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Since the covariates can easily be known in the future in this example, we can also define a <code class="docutils literal notranslate"><span class="pre">RNNModel</span></code> and train it using them as <code class="docutils literal notranslate"><span class="pre">future_covariate</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;RNN_test&quot;</span>
<span class="n">model_futcov</span> <span class="o">=</span> <span class="n">RNNModel</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">training_length</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
    <span class="n">save_checkpoints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># store model states: latest and best performing of validation set</span>
    <span class="n">force_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">generate_torch_kwargs</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">model_futcov</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="p">[</span><span class="n">train_air</span><span class="p">,</span> <span class="n">train_milk</span><span class="p">],</span>
    <span class="n">future_covariates</span><span class="o">=</span><span class="p">[</span><span class="n">air_covariates</span><span class="p">,</span> <span class="n">milk_covariates</span><span class="p">],</span>
    <span class="n">val_series</span><span class="o">=</span><span class="p">[</span><span class="n">val_air</span><span class="p">,</span> <span class="n">val_milk</span><span class="p">],</span>
    <span class="n">val_future_covariates</span><span class="o">=</span><span class="p">[</span><span class="n">air_covariates</span><span class="p">,</span> <span class="n">milk_covariates</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "54c586fd5c64491a8a66110cf0131e91", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RNNModel(model=LSTM, hidden_dim=20, n_rnn_layers=1, dropout=0.0, training_length=35, batch_size=8, n_epochs=100, random_state=0, input_chunk_length=24, model_name=RNN_test, save_checkpoints=True, force_reset=True, pl_trainer_kwargs={&#39;accelerator&#39;: &#39;cpu&#39;, &#39;callbacks&#39;: [&lt;darts.utils.callbacks.TFMProgressBar object at 0x2b69cb9d0&gt;]})
</pre></div></div>
</div>
<p>Now we load the model state with the best performance on the validation set to avoid overfitting.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_futurecov</span> <span class="o">=</span> <span class="n">RNNModel</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Forecasting-with-Covariates">
<h2>Forecasting with Covariates<a class="headerlink" href="#Forecasting-with-Covariates" title="Link to this heading">#</a></h2>
<p>similarly, getting a forecast is now only a matter of specifying the <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> argument to the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function for the <code class="docutils literal notranslate"><span class="pre">BlockRNNModel</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_cov</span> <span class="o">=</span> <span class="n">model_pastcov</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">train_air</span><span class="p">,</span> <span class="n">past_covariates</span><span class="o">=</span><span class="n">air_covariates</span><span class="p">)</span>

<span class="n">series_air_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">pred_cov</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x2b6abd4b0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_39_1.png" src="../_images/examples_01-multi-time-series-and-covariates_39_1.png" />
</div>
</div>
<p>Note that here we called <code class="docutils literal notranslate"><span class="pre">predict()</span></code> with a forecast horizon <code class="docutils literal notranslate"><span class="pre">n</span></code> that is larger than the <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code> we trained our model with. We were able to do this because even though <code class="docutils literal notranslate"><span class="pre">BlockRNNModel</span></code> uses past covariates, in this case these covariates are also known into the future, so Darts is able to compute the forecasts auto-regressively for <code class="docutils literal notranslate"><span class="pre">n</span></code> time steps in the future.</p>
<p>For the <code class="docutils literal notranslate"><span class="pre">RNNModel</span></code>, we can use a similar approach by just providing <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> to the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_cov</span> <span class="o">=</span> <span class="n">model_futcov</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">train_air</span><span class="p">,</span> <span class="n">future_covariates</span><span class="o">=</span><span class="n">air_covariates</span>
<span class="p">)</span>

<span class="n">series_air_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">pred_cov</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x2b6ba5540&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_41_1.png" src="../_images/examples_01-multi-time-series-and-covariates_41_1.png" />
</div>
</div>
</section>
<section id="Backtesting-with-Covariates">
<h2>Backtesting with Covariates<a class="headerlink" href="#Backtesting-with-Covariates" title="Link to this heading">#</a></h2>
<p>We can also backtest the models using covariates. Say for instance we are interested in evaluating the running accuracy with a horizon of 12 months start at the beginning of the validation series.</p>
<ul class="simple">
<li><p>we start at the beginning of the validation series (<code class="docutils literal notranslate"><span class="pre">start=val_air.start_time()</span></code>).</p></li>
<li><p>each prediction will have length <code class="docutils literal notranslate"><span class="pre">forecast_horizon=12</span></code>.</p></li>
<li><p>the next prediction will start <code class="docutils literal notranslate"><span class="pre">stride=12</span></code> points after the previous one</p></li>
<li><p>we keep all predicted values from each forecast (<code class="docutils literal notranslate"><span class="pre">last_points_only=False</span></code>)</p></li>
<li><p>the we continue until we run out of input data</p></li>
</ul>
<p>In the end we concatenate the historical forecasts to get a single continuous (on time axis) time series</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backtest_pastcov</span> <span class="o">=</span> <span class="n">model_pastcov</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">series_air_scaled</span><span class="p">,</span>
    <span class="n">past_covariates</span><span class="o">=</span><span class="n">air_covariates</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="n">val_air</span><span class="o">.</span><span class="n">start_time</span><span class="p">(),</span>
    <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">last_points_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">retrain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">backtest_pastcov</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">backtest_pastcov</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;MAPE (BlockRNNModel with past covariates) = </span><span class="si">{</span><span class="n">mape</span><span class="p">(</span><span class="n">series_air_scaled</span><span class="p">,</span><span class="w"> </span><span class="n">backtest_pastcov</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
<span class="p">)</span>

<span class="n">backtest_futcov</span> <span class="o">=</span> <span class="n">model_futcov</span><span class="o">.</span><span class="n">historical_forecasts</span><span class="p">(</span>
    <span class="n">series_air_scaled</span><span class="p">,</span>
    <span class="n">future_covariates</span><span class="o">=</span><span class="n">air_covariates</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="n">val_air</span><span class="o">.</span><span class="n">start_time</span><span class="p">(),</span>
    <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">last_points_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">retrain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">backtest_futcov</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">backtest_futcov</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;MAPE (RNNModel with future covariates) = </span><span class="si">{</span><span class="n">mape</span><span class="p">(</span><span class="n">series_air_scaled</span><span class="p">,</span><span class="w"> </span><span class="n">backtest_futcov</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "21c81307a941415f9081ea7ae8eebecc", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAPE (BlockRNNModel with past covariates) = 12.09%
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "032d55df0e1746dbb520389d9eeec001", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAPE (RNNModel with future covariates) = 10.26%
</pre></div></div>
</div>
<p>With the selected hyperparameters (and random seed), the <code class="docutils literal notranslate"><span class="pre">BlockRNNModel</span></code> using the <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> (MAPE=10.48%) seems to outperform the <code class="docutils literal notranslate"><span class="pre">RNNModel</span></code> with <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> (MAPE=15.21%). In order to have a better idea of the forecast obtained with these two models, it’s possible to plot them next to each other:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">series_air_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">backtest_pastcov</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast BlockRNN&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">series_air_scaled</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">backtest_futcov</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast RNN&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkviolet&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_45_0.png" src="../_images/examples_01-multi-time-series-and-covariates_45_0.png" />
</div>
</div>
</section>
<section id="A-few-more-words-on-past-covariates,-future-covariates-and-other-conditioning">
<h2>A few more words on past covariates, future covariates and other conditioning<a class="headerlink" href="#A-few-more-words-on-past-covariates,-future-covariates-and-other-conditioning" title="Link to this heading">#</a></h2>
<p>At the moment Darts supports covariates that are themselves time series. These covariates are used as model inputs, but are never themselves subject to prediction. The covariates do not necessarily have to be aligned with the target series (e.g. they do not need to start at the same time). Darts will use the actual time values of the <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> time axes in order to jointly slice the targets and covariates correctly, both for training and inference. Of course the covariates still need to
have a sufficient span, otherwise Darts will complain.</p>
<p>As explained above, <code class="docutils literal notranslate"><span class="pre">TCNModel</span></code>, <code class="docutils literal notranslate"><span class="pre">NBEATSModel</span></code>, <code class="docutils literal notranslate"><span class="pre">BlockRNNModel</span></code>, <code class="docutils literal notranslate"><span class="pre">TransformerModel</span></code> use past covariates (they will complain if you try using <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code>). If these past covariates happen to also be known into the future, then these models are also able to produce forecasts for <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;</span> <span class="pre">output_chunk_length</span></code> (as shown above for <code class="docutils literal notranslate"><span class="pre">BlockRNNModel</span></code>) in an auto-regressive way.</p>
<p>By contrast, <code class="docutils literal notranslate"><span class="pre">RNNModel</span></code> uses future covariates (it will complain if you try specifying <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code>). This means that prediction with this model requires the covariates (at least) <code class="docutils literal notranslate"><span class="pre">n</span></code> time steps into the future after prediction time.</p>
<p>Past and future covariates (as well as the way they are consumed by the different models) are an important but non-trivial topic, and we plan to dedicate a future notebook (or article) to explain this further.</p>
<section id="Training-and-Forecasting-Multivariate-TimeSeries">
<h3>Training and Forecasting Multivariate TimeSeries<a class="headerlink" href="#Training-and-Forecasting-Multivariate-TimeSeries" title="Link to this heading">#</a></h3>
<p>Now, instead of having to forecast only one variable, we would like to forecast several of them at once. In constrast of the multi-series training, where two different univariate datasets were used to train a single model, the training set consists in a single serie containing observations for several variables (called <code class="docutils literal notranslate"><span class="pre">components</span></code>). These <code class="docutils literal notranslate"><span class="pre">components</span></code> usually present the same nature (measurement of the same metric) but this is not necessarily the case.</p>
<p>Even if not be covered in this example, models can also be trained using several multivariate <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> by providing a sequence of such series to the <code class="docutils literal notranslate"><span class="pre">fit</span></code> method (on the condition that the model supports multivatiate <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> of course).</p>
<p>In order to illustrate this example, the <code class="docutils literal notranslate"><span class="pre">ElectricityDataset</span></code> (also available in Darts) will be used. This dataset contains measurements of electric power comsumption (in kW) for 370 clients with a sampling rate of 15 minutes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_serie_elec</span> <span class="o">=</span> <span class="n">ElectricityDataset</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Since this multivariate serie is particularly large (370 components, 140’256 values), we keep only 3 components before resampling the serie with a frequency of 1 hour. Finally, the last 168 values (one week) are retained to shorten the training duration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retaining only three components in different ranges</span>
<span class="n">retained_components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MT_002&quot;</span><span class="p">,</span> <span class="s2">&quot;MT_008&quot;</span><span class="p">,</span> <span class="s2">&quot;MT_009&quot;</span><span class="p">]</span>
<span class="n">multi_serie_elec</span> <span class="o">=</span> <span class="n">multi_serie_elec</span><span class="p">[</span><span class="n">retained_components</span><span class="p">]</span>
<span class="c1"># resampling the multivariate time serie</span>
<span class="n">multi_serie_elec</span> <span class="o">=</span> <span class="n">multi_serie_elec</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1H&quot;</span><span class="p">)</span>
<span class="c1"># keep the values for the last 5 days</span>
<span class="n">multi_serie_elec</span> <span class="o">=</span> <span class="n">multi_serie_elec</span><span class="p">[</span><span class="o">-</span><span class="mi">168</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multi_serie_elec</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_50_0.png" src="../_images/examples_01-multi-time-series-and-covariates_50_0.png" />
</div>
</div>
</section>
</section>
<section id="Data-preparation-and-inference-routine">
<h2>Data preparation and inference routine<a class="headerlink" href="#Data-preparation-and-inference-routine" title="Link to this heading">#</a></h2>
<p>We split the dataset in training (6 days) and validation set (1 day) and normalize the values. In Darts, all the models are trained by calling <code class="docutils literal notranslate"><span class="pre">fit</span></code> and infer using <code class="docutils literal notranslate"><span class="pre">predict</span></code>, it is thus possible to define short function <code class="docutils literal notranslate"><span class="pre">fit_and_pred</span></code> to wrap these two steps.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># split in train/validation sets</span>
<span class="n">training_set</span><span class="p">,</span> <span class="n">validation_set</span> <span class="o">=</span> <span class="n">multi_serie_elec</span><span class="p">[:</span><span class="o">-</span><span class="mi">24</span><span class="p">],</span> <span class="n">multi_serie_elec</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:]</span>

<span class="c1"># define a scaler, by default, normalize each component between 0 and 1</span>
<span class="n">scaler_dataset</span> <span class="o">=</span> <span class="n">Scaler</span><span class="p">()</span>
<span class="c1"># scaler is fit on training set only to avoid leakage</span>
<span class="n">training_scaled</span> <span class="o">=</span> <span class="n">scaler_dataset</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">training_set</span><span class="p">)</span>
<span class="n">validation_scaled</span> <span class="o">=</span> <span class="n">scaler_dataset</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">validation_set</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fit_and_pred</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">training</span><span class="p">,</span> <span class="n">validation</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>
    <span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">validation</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">forecast</span>
</pre></div>
</div>
</div>
<p>Now, we will define and train one <code class="docutils literal notranslate"><span class="pre">VARIMA</span></code> model and one <code class="docutils literal notranslate"><span class="pre">RNNModel</span></code> using the function defined above. Since the dataset is Integer-indexed, the <code class="docutils literal notranslate"><span class="pre">trend</span></code> argument for the <code class="docutils literal notranslate"><span class="pre">VARIMA</span></code> model must be set to <code class="docutils literal notranslate"><span class="pre">None</span></code> which is not really problematic since no trend is noticeable in the plot above.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_VARIMA</span> <span class="o">=</span> <span class="n">VARIMA</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="s2">&quot;n&quot;</span><span class="p">)</span>

<span class="n">model_GRU</span> <span class="o">=</span> <span class="n">RNNModel</span><span class="p">(</span>
    <span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">n_rnn_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">training_length</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="o">**</span><span class="n">generate_torch_kwargs</span><span class="p">(),</span>
<span class="p">)</span>

<span class="c1"># training and prediction with the VARIMA model</span>
<span class="n">forecast_VARIMA</span> <span class="o">=</span> <span class="n">fit_and_pred</span><span class="p">(</span><span class="n">model_VARIMA</span><span class="p">,</span> <span class="n">training_scaled</span><span class="p">,</span> <span class="n">validation_scaled</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE (VARIMA) = </span><span class="si">{</span><span class="n">mae</span><span class="p">(</span><span class="n">validation_scaled</span><span class="p">,</span><span class="w"> </span><span class="n">forecast_VARIMA</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># training and prediction with the RNN model</span>
<span class="n">forecast_RNN</span> <span class="o">=</span> <span class="n">fit_and_pred</span><span class="p">(</span><span class="n">model_GRU</span><span class="p">,</span> <span class="n">training_scaled</span><span class="p">,</span> <span class="n">validation_scaled</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE (RNN) = </span><span class="si">{</span><span class="n">mae</span><span class="p">(</span><span class="n">validation_scaled</span><span class="p">,</span><span class="w"> </span><span class="n">forecast_RNN</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAE (VARIMA) = 0.11
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9b0358f15cc1439f8d84f43b42729a48", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAE (RNN) = 0.10
</pre></div></div>
</div>
<p>Since we used a <code class="docutils literal notranslate"><span class="pre">Scaler</span></code> to normalize each component of the multivariate serie, we must not forget to scale them back in order to be able to properly visualise the forecasted values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast_VARIMA</span> <span class="o">=</span> <span class="n">scaler_dataset</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">forecast_VARIMA</span><span class="p">)</span>
<span class="n">forecast_RNN</span> <span class="o">=</span> <span class="n">scaler_dataset</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">forecast_RNN</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;forecast </span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">retained_components</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">validation_set</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">forecast_VARIMA</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;VARIMA model forecast&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">validation_set</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">forecast_RNN</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RNN model forecast&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_01-multi-time-series-and-covariates_56_0.png" src="../_images/examples_01-multi-time-series-and-covariates_56_0.png" />
</div>
</div>
<p>Due to the parameters selection, favoring speed over accuracy, the quality of the forecast is not great. Using more components from the original dataset or increasing the size of the training set should improve the accuracy of both models. Another possible improvement would be to account for the daily seasonality of the dataset by setting <code class="docutils literal notranslate"><span class="pre">p</span></code> (time lag) to 24 instead of 12 in the <code class="docutils literal notranslate"><span class="pre">VARIMA</span></code> model, and to retrain it.</p>
</section>
<section id="Comments-on-training-using-multivariate-series">
<h2>Comments on training using multivariate series<a class="headerlink" href="#Comments-on-training-using-multivariate-series" title="Link to this heading">#</a></h2>
<p>All the features shown ealier on univariate <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code>, notably using covariates (past and future) or sequence of series, are of course also compatible with multivariate <code class="docutils literal notranslate"><span class="pre">TimeSeries</span></code> (just make sure that the model used actually supports them).</p>
<p>Furthermore, the models supporting multivariates series might use different approaches. <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> for example, uses a specialized module to select the relevant features whereas <code class="docutils literal notranslate"><span class="pre">NBEATSModel</span></code> flatten the serie’s components into an univariate serie and rely on its fully connected layers to capture the interactions between the features.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../examples.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Examples</p>
      </div>
    </a>
    <a class="right-next"
       href="02-data-processing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Data (pre) processing using <code class="docutils literal notranslate"><span class="pre">DataTransformer</span></code> and <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Read-Data">Read Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Preprocessing">Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Train-/-Validation-split">Train / Validation split</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Global-Forecasting-Models">Global Forecasting Models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Example-with-one-Series">Example with one Series</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-Process-(behind-the-scenes)">Training Process (behind the scenes)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-a-Model-on-Multiple-Time-Series">Training a Model on Multiple Time Series</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-on-Both-Air-Traffic-and-Milk-Series">Training on Both Air Traffic and Milk Series</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Producing-Forecasts-After-the-End-of-a-Series">Producing Forecasts After the End of a Series</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Wait...-does-this-mean-that-milk-production-helps-to-predict-air-traffic??">Wait… does this mean that milk production helps to predict air traffic??</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Covariates-Series">Covariates Series</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#Building-Covariates">Building Covariates</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-with-Covariates">Training with Covariates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Forecasting-with-Covariates">Forecasting with Covariates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Backtesting-with-Covariates">Backtesting with Covariates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#A-few-more-words-on-past-covariates,-future-covariates-and-other-conditioning">A few more words on past covariates, future covariates and other conditioning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Training-and-Forecasting-Multivariate-TimeSeries">Training and Forecasting Multivariate TimeSeries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Data-preparation-and-inference-routine">Data preparation and inference routine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Comments-on-training-using-multivariate-series">Comments on training using multivariate series</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples/01-multi-time-series-and-covariates.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2020 - 2025, Unit8 SA (Apache 2.0 License).
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>